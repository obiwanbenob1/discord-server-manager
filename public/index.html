<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Discord Manager - Free tool to organize, categorize, and manage your Discord servers. Track growth, audit permissions, and export your server data.">
    <meta name="keywords" content="Discord, server manager, Discord tools, server organization, Discord security">
    <meta name="author" content="@ObiWanBENobiETH">
    <meta property="og:title" content="Discord Manager - Complete Server Management Suite">
    <meta property="og:description" content="Organize and manage your Discord servers with powerful tools for categorization, growth tracking, and security auditing.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.discordmanage.com">
    <title>Discord Manager - Complete Suite</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2300ff88'/><circle cx='50' cy='50' r='40' fill='%230a0e27'/><circle cx='50' cy='50' r='15' fill='%2300ff88'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Archivo+Black&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151937;
            --bg-card: #1a1f3a;
            --accent-primary: #00ff88;
            --accent-secondary: #00d4ff;
            --accent-danger: #ff3366;
            --accent-warning: #ffaa00;
            --text-primary: #e8f4f8;
            --text-secondary: #8b9dc3;
            --border: #2a3354;
            --shadow: rgba(0, 255, 136, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            padding: 4rem 0 3rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
            opacity: 0.1;
            filter: blur(60px);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.15; transform: translateX(-50%) scale(1.1); }
        }

        h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 3.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .login-section {
            text-align: center;
            padding: 4rem 2rem;
            animation: fadeIn 1s ease-out 0.4s both;
        }

        .login-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            border: none;
            padding: 1.2rem 3rem;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Space Mono', monospace;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s ease;
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px var(--shadow);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--accent-primary);
        }

        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
            animation: fadeIn 0.8s ease-out;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem 1rem;
            text-align: center;
            transition: all 0.3s ease;
            min-width: 0;
            overflow: hidden;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px var(--shadow);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-primary);
            font-family: 'Archivo Black', sans-serif;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.5rem;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-primary);
            font-family: 'Archivo Black', sans-serif;
            line-height: 1;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .stat-value {
                font-size: 2rem;
            }
            .stat-label {
                font-size: 0.75rem;
            }
            
            /* Mobile: Stack controls vertically */
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls button,
            .controls select {
                width: 100%;
            }
            
            /* Mobile: Stack stats vertically */
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Mobile: Single column insights */
            .insight-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Mobile: Smaller modals */
            .modal {
                max-width: 95vw !important;
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Mobile: Compact tabs */
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }
            
            /* Mobile: Compact server cards */
            .item-card {
                padding: 1rem;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .item-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            /* Mobile: Stack buttons */
            .user-info {
                flex-direction: column;
                align-items: stretch;
            }
            
            .user-info button {
                width: 100%;
                margin-top: 0.5rem;
            }
            
            /* Mobile: Smaller text */
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            h3 {
                font-size: 1.2rem;
            }
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--shadow);
        }

        .btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .btn-danger {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #ff1a4d;
            border-color: #ff1a4d;
            box-shadow: 0 4px 20px rgba(255, 51, 102, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .item-list {
            display: grid;
            gap: 1rem;
        }

        .item-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            animation: slideUp 0.4s ease-out both;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .item-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .item-card.selected {
            border-color: var(--accent-secondary);
            background: rgba(0, 212, 255, 0.05);
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .item-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            flex-shrink: 0;
            border: 2px solid var(--border);
            overflow: hidden;
        }

        .item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .item-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: 0.5rem;
        }

        .badge-primary {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-primary);
        }

        .badge-secondary {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-secondary);
        }

        .badge-danger {
            background: rgba(255, 51, 102, 0.2);
            color: var(--accent-danger);
        }

        .badge-warning {
            background: rgba(255, 170, 0, 0.2);
            color: var(--accent-warning);
        }

        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .info-box {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-box p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
        }

        .user-details {
            flex: 1;
            min-width: 0;
            margin-right: 1rem;
        }

        .user-name {
            font-weight: bold;
            color: var(--accent-primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal {
            background: var(--bg-card);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 255, 136, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .modal h2 {
            color: var(--accent-primary);
            margin-bottom: 1rem;
            font-family: 'Archivo Black', sans-serif;
        }

        .modal-steps {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .modal-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .modal-step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            background: var(--accent-primary);
            color: var(--bg-primary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-text {
            flex: 1;
            padding-top: 0.2rem;
        }

        .modal-close {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .server-opened {
            color: var(--accent-secondary);
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .insight-grid {
            display: grid;
            gap: 2rem;
        }

        .insight-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
        }

        .insight-section h3 {
            color: var(--accent-primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .connection-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .connection-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--bg-primary);
        }

        .connection-details {
            flex: 1;
        }

        .connection-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .connection-type {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .category-filter {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .category-chip {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-chip:hover {
            border-color: var(--accent-primary);
        }

        .category-chip.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .warning-box {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid var(--accent-warning);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .warning-box strong {
            color: var(--accent-warning);
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ===== GLOBAL STATE =====
        let state = {
            isAuthenticated: false,
            loading: false,
            error: null,
            currentTab: 'servers',
            
            // User data
            user: null,
            accessToken: null,
            
            // Servers
            servers: [],
            selectedServers: new Set(),
            
            // Connections
            connections: [],
            
            // UI state
            searchTerm: '',
            sortBy: 'name',
            categoryFilter: 'all', // all, gaming, personal, work, large, owned, uncategorized, favorites
            showHealthScores: true,
            
            // Manual categorization (stored in localStorage)
            serverCategories: {}, // { serverId: ['gaming', 'personal'] }
            
            // Phase 1 Features (all stored in localStorage)
            serverNotes: {}, // { serverId: 'My note about this server' }
            serverReminders: {}, // { serverId: { date: timestamp, note: 'Reminder text' } }
            favoriteServers: new Set(), // Set of server IDs
            lastVisited: {}, // { serverId: timestamp }
            serverHealth: {}, // { serverId: { score: 0-100, issues: [] } }
            
            // Phase 2 Features (analytics - REAL DATA ONLY)
            serverComparison: [], // Array of server IDs being compared
            
            // Phase 3 Features (gaming & productivity)
            gameDetections: {}, // { serverId: 'Valorant' | 'League of Legends' | etc }
            lfgServers: new Set(), // Set of server IDs marked as LFG
            theme: 'dark', // 'dark' | 'light' | 'custom'
            savedPresets: [], // [{ name, filters, selectedServers }]
            
            // Growth tracking (stored in localStorage)
            growthHistory: {}, // { serverId: [{ date, memberCount }] }
            lastSnapshot: null,
            
            // Advanced filters
            advancedFilters: {
                memberCountMin: null,
                memberCountMax: null,
                joinedAfter: null,
                joinedBefore: null,
                hasRole: null,
                healthMin: null
            },
            
            // Multi-account (future feature)
            accounts: []
        };

        // Available categories
        const CATEGORIES = {
            gaming: { emoji: 'üéÆ', label: 'Gaming' },
            work: { emoji: 'üíº', label: 'Work' },
            personal: { emoji: 'üë•', label: 'Personal' },
            education: { emoji: 'üìö', label: 'Education' },
            creative: { emoji: 'üé®', label: 'Creative' },
            tech: { emoji: 'üíª', label: 'Tech' },
            hobby: { emoji: 'üéØ', label: 'Hobby' },
            community: { emoji: 'üåê', label: 'Community' }
        };

        // Health score thresholds
        const HEALTH_THRESHOLDS = {
            excellent: 80,
            good: 60,
            warning: 40,
            poor: 0
        };

        // ===== INITIALIZATION =====
        function init() {
            loadGrowthHistory();
            loadServerCategories();
            loadPhase1Data();
            loadPhase3Data();
            handleOAuthCallback();
            applyTheme(); // Apply saved theme
            render();
            
            // Check reminders periodically (every minute) - only if authenticated
            if (state.isAuthenticated) {
                setInterval(checkReminders, 60000);
            }
        }

        // Load all Phase 1 data from localStorage
        function loadPhase1Data() {
            try {
                // Server notes
                const notes = localStorage.getItem('discord_server_notes');
                if (notes) state.serverNotes = JSON.parse(notes);
                
                // Reminders
                const reminders = localStorage.getItem('discord_server_reminders');
                if (reminders) state.serverReminders = JSON.parse(reminders);
                
                // Favorites
                const favorites = localStorage.getItem('discord_favorite_servers');
                if (favorites) state.favoriteServers = new Set(JSON.parse(favorites));
                
                // Last visited
                const visited = localStorage.getItem('discord_last_visited');
                if (visited) state.lastVisited = JSON.parse(visited);
                
                // Health scores
                const health = localStorage.getItem('discord_server_health');
                if (health) state.serverHealth = JSON.parse(health);
            } catch (e) {
                console.warn('Failed to load Phase 1 data:', e);
            }
        }

        function savePhase1Data() {
            try {
                localStorage.setItem('discord_server_notes', JSON.stringify(state.serverNotes));
                localStorage.setItem('discord_server_reminders', JSON.stringify(state.serverReminders));
                localStorage.setItem('discord_favorite_servers', JSON.stringify(Array.from(state.favoriteServers)));
                localStorage.setItem('discord_last_visited', JSON.stringify(state.lastVisited));
                localStorage.setItem('discord_server_health', JSON.stringify(state.serverHealth));
            } catch (e) {
                console.warn('Failed to save Phase 1 data:', e);
            }
        }

        // Load all Phase 3 data from localStorage
        function loadPhase3Data() {
            try {
                // Game detections
                const games = localStorage.getItem('discord_game_detections');
                if (games) state.gameDetections = JSON.parse(games);
                
                // LFG servers
                const lfg = localStorage.getItem('discord_lfg_servers');
                if (lfg) state.lfgServers = new Set(JSON.parse(lfg));
                
                // Theme
                const theme = localStorage.getItem('discord_theme');
                if (theme) state.theme = theme;
                
                // Saved presets
                const presets = localStorage.getItem('discord_saved_presets');
                if (presets) state.savedPresets = JSON.parse(presets);
            } catch (e) {
                console.warn('Failed to load Phase 3 data:', e);
            }
        }

        function savePhase3Data() {
            try {
                localStorage.setItem('discord_game_detections', JSON.stringify(state.gameDetections));
                localStorage.setItem('discord_lfg_servers', JSON.stringify(Array.from(state.lfgServers)));
                localStorage.setItem('discord_theme', state.theme);
                localStorage.setItem('discord_saved_presets', JSON.stringify(state.savedPresets));
            } catch (e) {
                console.warn('Failed to save Phase 3 data:', e);
            }
        }

        // ===== OAUTH & AUTH =====
        function handleOAuthCallback() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const error = params.get('error');
            
            if (error) {
                state.error = 'Authentication failed. Please try again.';
                window.history.replaceState({}, document.title, window.location.pathname);
                render();
                return;
            }
            
            if (token) {
                state.accessToken = token;
                try {
                    localStorage.setItem('discord_token', token);
                } catch (e) {
                    sessionStorage.setItem('discord_token', token);
                }
                window.history.replaceState({}, document.title, window.location.pathname);
                loadDiscordData(token);
            } else {
                let savedToken = null;
                try {
                    savedToken = localStorage.getItem('discord_token');
                } catch (e) {
                    savedToken = sessionStorage.getItem('discord_token');
                }
                if (savedToken) {
                    state.accessToken = savedToken;
                    loadDiscordData(savedToken);
                }
            }
        }

        async function handleDiscordLogin() {
            try {
                const response = await fetch('/api/auth/url');
                const data = await response.json();
                window.location.href = data.url;
            } catch (error) {
                state.error = 'Failed to initiate login. Please try again.';
                render();
            }
        }

        async function loadDiscordData(token) {
            state.loading = true;
            state.error = null;
            render();

            try {
                console.log('Starting Discord data fetch...');
                
                // Fetch user info
                const userResponse = await fetch('/api/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log('User response status:', userResponse.status);
                
                if (!userResponse.ok) {
                    const errorData = await userResponse.json().catch(() => ({}));
                    console.error('User fetch failed:', errorData);
                    throw new Error(`Failed to fetch user data: ${errorData.error || userResponse.statusText}`);
                }
                state.user = await userResponse.json();
                console.log('User fetched successfully:', state.user.username);

                // Fetch guilds
                const guildsResponse = await fetch('/api/guilds', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log('Guilds response status:', guildsResponse.status);
                
                if (!guildsResponse.ok) {
                    const errorData = await guildsResponse.json().catch(() => ({}));
                    console.error('Guilds fetch failed:', errorData);
                    throw new Error(`Failed to fetch servers: ${errorData.error || guildsResponse.statusText}`);
                }
                state.servers = await guildsResponse.json();
                console.log(`Successfully fetched ${state.servers.length} servers`);

                // Fetch connections
                try {
                    const connectionsResponse = await fetch('/api/connections', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (connectionsResponse.ok) {
                        state.connections = await connectionsResponse.json();
                        console.log(`Fetched ${state.connections.length} connections`);
                    }
                } catch (e) {
                    console.warn('Failed to fetch connections:', e);
                }

                state.isAuthenticated = true;
                state.loading = false;
                
                // Calculate real analytics AFTER servers are loaded
                takeServerSnapshot();
                calculateAllServerHealth();
                detectAllGames(); // Phase 3: Detect games
                checkReminders();
                
                render();
            } catch (error) {
                console.error('Load Discord data error:', error);
                state.error = error.message;
                state.loading = false;
                localStorage.removeItem('discord_token');
                sessionStorage.removeItem('discord_token');
                render();
            }
        }

        function handleLogout() {
            localStorage.removeItem('discord_token');
            sessionStorage.removeItem('discord_token');
            state = {
                isAuthenticated: false,
                loading: false,
                error: null,
                currentTab: 'servers',
                user: null,
                accessToken: null,
                servers: [],
                selectedServers: new Set(),
                connections: [],
                searchTerm: '',
                sortBy: 'name',
                categoryFilter: 'all',
                growthHistory: state.growthHistory, // Keep growth history
                lastSnapshot: state.lastSnapshot,
                accounts: []
            };
            render();
        }

        // ===== GROWTH TRACKING =====
        function loadGrowthHistory() {
            try {
                const saved = localStorage.getItem('discord_growth_history');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.growthHistory = data.history || {};
                    state.lastSnapshot = data.lastSnapshot || null;
                }
            } catch (e) {
                console.warn('Failed to load growth history:', e);
            }
        }

        function saveGrowthHistory() {
            try {
                localStorage.setItem('discord_growth_history', JSON.stringify({
                    history: state.growthHistory,
                    lastSnapshot: state.lastSnapshot
                }));
            } catch (e) {
                console.warn('Failed to save growth history:', e);
            }
        }

        function takeServerSnapshot() {
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            
            // Only take snapshot once per day
            if (state.lastSnapshot && state.lastSnapshot > oneDayAgo) {
                return;
            }
            
            state.servers.forEach(server => {
                if (!state.growthHistory[server.id]) {
                    state.growthHistory[server.id] = [];
                }
                
                state.growthHistory[server.id].push({
                    date: now,
                    memberCount: server.memberCount
                });
                
                // Keep only last 90 days
                const ninetyDaysAgo = now - (90 * 24 * 60 * 60 * 1000);
                state.growthHistory[server.id] = state.growthHistory[server.id].filter(
                    snapshot => snapshot.date > ninetyDaysAgo
                );
            });
            
            state.lastSnapshot = now;
            saveGrowthHistory();
        }

        function getServerGrowth(serverId) {
            const history = state.growthHistory[serverId] || [];
            if (history.length < 2) return null;
            
            const latest = history[history.length - 1];
            const oldest = history[0];
            const change = latest.memberCount - oldest.memberCount;
            const percentChange = ((change / oldest.memberCount) * 100).toFixed(1);
            
            return {
                change,
                percentChange,
                oldCount: oldest.memberCount,
                newCount: latest.memberCount,
                trending: change > 0 ? 'up' : change < 0 ? 'down' : 'stable',
                dataPoints: history.length
            };
        }

        // ===== MANUAL CATEGORIZATION =====
        function loadServerCategories() {
            try {
                const saved = localStorage.getItem('discord_server_categories');
                if (saved) {
                    state.serverCategories = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Failed to load server categories:', e);
            }
        }

        function saveServerCategories() {
            try {
                localStorage.setItem('discord_server_categories', JSON.stringify(state.serverCategories));
            } catch (e) {
                console.warn('Failed to save server categories:', e);
            }
        }

        function toggleServerCategory(serverId, category) {
            if (!state.serverCategories[serverId]) {
                state.serverCategories[serverId] = [];
            }
            
            const categories = state.serverCategories[serverId];
            const index = categories.indexOf(category);
            
            if (index > -1) {
                categories.splice(index, 1);
            } else {
                categories.push(category);
            }
            
            saveServerCategories();
            render();
        }

        function setServerCategories(serverId, categories) {
            state.serverCategories[serverId] = categories;
            saveServerCategories();
            render();
        }

        function bulkCategorize(category) {
            const selected = Array.from(state.selectedServers);
            selected.forEach(serverId => {
                if (!state.serverCategories[serverId]) {
                    state.serverCategories[serverId] = [];
                }
                if (!state.serverCategories[serverId].includes(category)) {
                    state.serverCategories[serverId].push(category);
                }
            });
            saveServerCategories();
            render();
        }

        // ===== SERVER CATEGORIZATION =====
        function categorizeServer(server) {
            // Use manual categories if set
            if (state.serverCategories[server.id] && state.serverCategories[server.id].length > 0) {
                return state.serverCategories[server.id];
            }
            
            // Otherwise show as uncategorized
            const autoCategories = [];
            
            // Only auto-detect size-based and ownership
            if (server.owner) autoCategories.push('owned');
            if (server.memberCount > 5000) autoCategories.push('large');
            
            return autoCategories.length > 0 ? autoCategories : ['uncategorized'];
        }

        function getSuggestedCategories(server) {
            // Provide smart suggestions based on keywords
            const suggestions = [];
            const nameLower = server.name.toLowerCase();
            
            // Gaming suggestions
            if (nameLower.match(/game|gaming|gamer|play|clan|guild|fps|mmo|rpg|valorant|apex|fortnite|cod|minecraft|league|overwatch|csgo|destiny|wow|pokemon|twitch|esport/)) {
                suggestions.push('gaming');
            }
            
            // Work suggestions
            if (nameLower.match(/work|team|company|corp|business|office|professional|studio|agency/)) {
                suggestions.push('work');
            }
            
            // Personal/Friend suggestions (small servers)
            if (server.memberCount < 50) {
                suggestions.push('personal');
            }
            
            // Education suggestions
            if (nameLower.match(/study|learn|school|university|college|education|class|course/)) {
                suggestions.push('education');
            }
            
            // Creative suggestions
            if (nameLower.match(/art|creative|design|music|draw|artist|portfolio/)) {
                suggestions.push('creative');
            }
            
            // Tech suggestions
            if (nameLower.match(/dev|code|programming|tech|software|engineer|linux|python|javascript|react/)) {
                suggestions.push('tech');
            }
            
            // Community suggestions
            if (server.memberCount > 1000 && !nameLower.match(/game|gaming/)) {
                suggestions.push('community');
            }
            
            return suggestions;
        }

        // ===== PHASE 1: SERVER NOTES & REMINDERS =====
        function setServerNote(serverId, note) {
            if (note.trim()) {
                state.serverNotes[serverId] = note.trim();
            } else {
                delete state.serverNotes[serverId];
            }
            savePhase1Data();
            render();
        }

        function setServerReminder(serverId, date, note) {
            if (date && note) {
                state.serverReminders[serverId] = { date: new Date(date).getTime(), note: note.trim() };
            } else {
                delete state.serverReminders[serverId];
            }
            savePhase1Data();
            render();
        }

        function checkReminders() {
            const now = Date.now();
            const due = Object.entries(state.serverReminders).filter(([id, reminder]) => reminder.date <= now);
            
            if (due.length > 0) {
                const server = state.servers.find(s => s.id === due[0][0]);
                if (server) {
                    alert(`‚è∞ Reminder: ${due[0][1].note}\n\nServer: ${server.name}`);
                    delete state.serverReminders[due[0][0]];
                    savePhase1Data();
                }
            }
        }

        // ===== PHASE 1: FAVORITES =====
        function toggleFavorite(serverId) {
            if (state.favoriteServers.has(serverId)) {
                state.favoriteServers.delete(serverId);
            } else {
                state.favoriteServers.add(serverId);
            }
            savePhase1Data();
            render();
        }

        // ===== PHASE 1: LAST VISITED TRACKING =====
        function recordVisit(serverId) {
            state.lastVisited[serverId] = Date.now();
            savePhase1Data();
            calculateServerHealth(serverId);
        }

        function getDaysSinceVisit(serverId) {
            if (!state.lastVisited[serverId]) return null;
            const days = Math.floor((Date.now() - state.lastVisited[serverId]) / (1000 * 60 * 60 * 24));
            return days;
        }

        // ===== DISCORD OPENER =====
        // Note: Mobile deep linking to specific Discord servers is not reliable
        // This is a Discord app limitation. Desktop works perfectly.
        function openDiscordServer(serverId) {
            recordVisit(serverId);
            
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const url = isMobile 
                ? `https://discord.com/channels/${serverId}`
                : `discord://discord.com/channels/${serverId}`;
            
            window.open(url, '_blank');
        }

        // ===== PHASE 1: SERVER HEALTH SCORING =====
        function calculateServerHealth(serverId) {
            const result = calculateEnhancedHealth(serverId);
            state.serverHealth[serverId] = result;
            savePhase1Data();
        }

        function calculateAllServerHealth() {
            state.servers.forEach(server => calculateServerHealth(server.id));
        }

        function getHealthColor(score) {
            if (score >= HEALTH_THRESHOLDS.excellent) return 'var(--accent-primary)';
            if (score >= HEALTH_THRESHOLDS.good) return 'var(--accent-secondary)';
            if (score >= HEALTH_THRESHOLDS.warning) return 'var(--accent-warning)';
            return 'var(--accent-danger)';
        }

        function getHealthLabel(score) {
            if (score >= HEALTH_THRESHOLDS.excellent) return 'üü¢ Excellent';
            if (score >= HEALTH_THRESHOLDS.good) return 'üîµ Good';
            if (score >= HEALTH_THRESHOLDS.warning) return 'üü° Review';
            return 'üî¥ Poor';
        }

        // ===== PHASE 2: ROLE ANALYZER =====
        function getAllRoles() {
            const roleMap = new Map(); // roleName -> [serverIds]
            
            state.servers.forEach(server => {
                // Parse permissions to detect roles
                const perms = analyzePermissions(server);
                
                perms.forEach(perm => {
                    const roleName = perm.text;
                    if (!roleMap.has(roleName)) {
                        roleMap.set(roleName, []);
                    }
                    roleMap.get(roleName).push({
                        serverId: server.id,
                        serverName: server.name,
                        level: perm.level
                    });
                });
                
                // Add owner role
                if (server.owner) {
                    if (!roleMap.has('Owner')) {
                        roleMap.set('Owner', []);
                    }
                    roleMap.get('Owner').push({
                        serverId: server.id,
                        serverName: server.name,
                        level: 'high'
                    });
                }
            });
            
            return roleMap;
        }

        // ===== PHASE 2: SERVER COMPARISON =====
        function compareSelectedServers() {
            const selectedArray = Array.from(state.selectedServers);
            
            if (selectedArray.length < 2) {
                alert('Please select at least 2 servers to compare!');
                return;
            }

            if (selectedArray.length > 5) {
                alert('You can compare up to 5 servers at once. Please select fewer servers.');
                return;
            }

            // Directly show comparison modal with selected servers
            showComparisonModalWithServers(selectedArray);
        }

        function showComparisonModalWithServers(serverIds) {
            const servers = serverIds
                .map(id => state.servers.find(s => s.id === id))
                .filter(Boolean);

            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 900px;">
                        <h2>‚öñÔ∏è Server Comparison</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Comparing ${servers.length} servers
                        </p>

                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-secondary);">
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--border);">Metric</th>
                                        ${servers.map(s => `
                                            <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border); max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${s.name}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Members</td>
                                        ${servers.map(s => `
                                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${s.memberCount.toLocaleString()}</td>
                                        `).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Health Score</td>
                                        ${servers.map(s => {
                                            const health = state.serverHealth[s.id] || { score: 0 };
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border); color: ${getHealthColor(health.score)}; font-weight: bold;">${health.score}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Growth</td>
                                        ${servers.map(s => {
                                            const growth = getServerGrowth(s.id);
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${growth ? growth.percentChange + '%' : 'N/A'}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Last Visited</td>
                                        ${servers.map(s => {
                                            const days = getDaysSinceVisit(s.id);
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${days !== null ? days + 'd ago' : 'Never'}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Has Notes</td>
                                        ${servers.map(s => {
                                            const hasNote = !!state.serverNotes[s.id];
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${hasNote ? '‚úì' : '‚úó'}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Favorite</td>
                                        ${servers.map(s => {
                                            const isFav = state.favoriteServers.has(s.id);
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${isFav ? '‚≠ê' : '‚òÜ'}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Owner</td>
                                        ${servers.map(s => `
                                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${s.owner ? '‚úì' : '‚úó'}</td>
                                        `).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <button class="modal-close" onclick="closeModal()" style="margin-top: 1.5rem;">Close</button>
                    </div>
                </div>
            `;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // Legacy functions (keeping for Analytics tab compatibility)
        function addToComparison(serverId) {
            if (!state.serverComparison.includes(serverId)) {
                state.serverComparison.push(serverId);
                if (state.serverComparison.length > 5) {
                    state.serverComparison.shift(); // Max 5 servers
                }
            }
            render();
        }

        function removeFromComparison(serverId) {
            state.serverComparison = state.serverComparison.filter(id => id !== serverId);
            render();
        }

        function clearComparison() {
            state.serverComparison = [];
            render();
        }

        function showComparisonModal() {
            if (state.serverComparison.length < 2) {
                alert('Please add at least 2 servers to compare!');
                return;
            }

            const servers = state.serverComparison
                .map(id => state.servers.find(s => s.id === id))
                .filter(Boolean);

            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 900px;">
                        <h2>‚öñÔ∏è Server Comparison</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Comparing ${servers.length} servers
                        </p>

                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-secondary);">
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--border);">Metric</th>
                                        ${servers.map(s => `
                                            <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${s.name}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Members</td>
                                        ${servers.map(s => `
                                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${s.memberCount.toLocaleString()}</td>
                                        `).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Health Score</td>
                                        ${servers.map(s => {
                                            const health = state.serverHealth[s.id] || { score: 0 };
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border); color: ${getHealthColor(health.score)}; font-weight: bold;">${health.score}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Growth</td>
                                        ${servers.map(s => {
                                            const growth = getServerGrowth(s.id);
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${growth ? growth.percentChange + '%' : 'N/A'}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Last Visited</td>
                                        ${servers.map(s => {
                                            const days = getDaysSinceVisit(s.id);
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${days !== null ? days + 'd ago' : 'Never'}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Has Notes</td>
                                        ${servers.map(s => {
                                            const hasNote = !!state.serverNotes[s.id];
                                            return `<td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${hasNote ? '‚úì' : '‚úó'}</td>`;
                                        }).join('')}
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">Owner</td>
                                        ${servers.map(s => `
                                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border);">${s.owner ? '‚úì' : '‚úó'}</td>
                                        `).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <button class="modal-close" onclick="closeModal()" style="margin-top: 1.5rem;">Close</button>
                    </div>
                </div>
            `;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // ===== PHASE 3: GAME SERVER DETECTOR =====
        const GAME_KEYWORDS = {
            'Valorant': ['valorant', 'val ', 'valo'],
            'League of Legends': ['league', 'lol ', 'league of legends', 'lol community'],
            'Minecraft': ['minecraft', 'mc ', 'mcpe', 'java edition'],
            'Fortnite': ['fortnite', 'fn ', 'fort'],
            'Apex Legends': ['apex', 'apex legends'],
            'CS:GO': ['csgo', 'cs:go', 'counter strike', 'cs2'],
            'Overwatch': ['overwatch', 'ow ', 'ow2'],
            'Destiny': ['destiny', 'destiny 2', 'd2'],
            'Call of Duty': ['cod ', 'call of duty', 'warzone', 'mw2', 'mw3'],
            'Dota 2': ['dota', 'dota 2'],
            'Rocket League': ['rocket league', 'rl '],
            'Rainbow Six': ['rainbow six', 'r6', 'siege'],
            'World of Warcraft': ['wow ', 'world of warcraft', 'warcraft'],
            'Final Fantasy': ['ff14', 'ffxiv', 'final fantasy'],
            'Genshin Impact': ['genshin', 'genshin impact'],
            'Roblox': ['roblox', 'rbx'],
            'Among Us': ['among us', 'amongus'],
            'Dead by Daylight': ['dbd', 'dead by daylight'],
            'Rust': ['rust game', 'rust pvp'],
            'Terraria': ['terraria'],
            'Stardew Valley': ['stardew'],
            'Pok√©mon': ['pokemon', 'pok√©mon'],
            'Escape from Tarkov': ['tarkov', 'eft']
        };

        function detectGameForServer(server) {
            const nameLower = server.name.toLowerCase();
            
            for (const [game, keywords] of Object.entries(GAME_KEYWORDS)) {
                for (const keyword of keywords) {
                    if (nameLower.includes(keyword)) {
                        return game;
                    }
                }
            }
            
            return null;
        }

        function detectAllGames() {
            state.servers.forEach(server => {
                const game = detectGameForServer(server);
                if (game) {
                    state.gameDetections[server.id] = game;
                }
            });
            savePhase3Data();
            console.log('Game detection complete:', Object.keys(state.gameDetections).length, 'games detected');
        }

        function getServersByGame() {
            const gameMap = new Map();
            
            for (const [serverId, game] of Object.entries(state.gameDetections)) {
                if (!gameMap.has(game)) {
                    gameMap.set(game, []);
                }
                const server = state.servers.find(s => s.id === serverId);
                if (server) {
                    gameMap.get(game).push(server);
                }
            }
            
            return gameMap;
        }

        // ===== PHASE 3: LFG TRACKER =====
        function toggleLFG(serverId) {
            if (state.lfgServers.has(serverId)) {
                state.lfgServers.delete(serverId);
            } else {
                state.lfgServers.add(serverId);
            }
            savePhase3Data();
            render();
        }

        // ===== PHASE 3: THEME SYSTEM =====
        function setTheme(theme) {
            state.theme = theme;
            savePhase3Data();
            applyTheme();
            render();
        }

        function applyTheme() {
            const root = document.documentElement;
            
            if (state.theme === 'light') {
                root.style.setProperty('--bg-primary', '#ffffff');
                root.style.setProperty('--bg-secondary', '#f5f5f5');
                root.style.setProperty('--bg-card', '#ffffff');
                root.style.setProperty('--text-primary', '#1a1a1a');
                root.style.setProperty('--text-secondary', '#666666');
                root.style.setProperty('--border', '#e0e0e0');
                root.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.1)');
            } else if (state.theme === 'dark') {
                // Default dark theme (already set in CSS)
                root.style.setProperty('--bg-primary', '#0a0e27');
                root.style.setProperty('--bg-secondary', '#151b3d');
                root.style.setProperty('--bg-card', '#1a2142');
                root.style.setProperty('--text-primary', '#ffffff');
                root.style.setProperty('--text-secondary', '#8b9dc3');
                root.style.setProperty('--border', '#2a3454');
                root.style.setProperty('--shadow', 'rgba(0, 255, 136, 0.1)');
            }
        }

        // ===== PHASE 3: TEMPLATES & PRESETS =====
        function saveCurrentPreset() {
            const presetName = prompt('Enter a name for this preset:');
            if (!presetName) return;

            const preset = {
                name: presetName,
                timestamp: Date.now(),
                categoryFilter: state.categoryFilter,
                sortBy: state.sortBy,
                searchTerm: state.searchTerm,
                selectedServers: Array.from(state.selectedServers)
            };

            state.savedPresets.push(preset);
            savePhase3Data();
            alert(`Preset "${presetName}" saved!`);
            render();
        }

        function loadPreset(index) {
            const preset = state.savedPresets[index];
            if (!preset) return;

            // Clear everything first
            state.selectedServers.clear();
            state.categoryFilter = preset.categoryFilter;
            state.sortBy = preset.sortBy;
            state.searchTerm = preset.searchTerm || '';
            
            // Load saved selections
            preset.selectedServers.forEach(id => state.selectedServers.add(id));
            
            alert(`Loaded preset: ${preset.name}`);
            render();
        }

        function deletePreset(index) {
            if (!confirm(`Delete preset "${state.savedPresets[index].name}"?`)) return;
            
            state.savedPresets.splice(index, 1);
            savePhase3Data();
            render();
        }

        // ===== PHASE 3: BACKUP & RESTORE =====
        function exportAllData() {
            const backup = {
                version: '1.0',
                timestamp: Date.now(),
                data: {
                    serverCategories: state.serverCategories,
                    serverNotes: state.serverNotes,
                    serverReminders: state.serverReminders,
                    favoriteServers: Array.from(state.favoriteServers),
                    lastVisited: state.lastVisited,
                    serverHealth: state.serverHealth,
                    growthHistory: state.growthHistory,
                    gameDetections: state.gameDetections,
                    lfgServers: Array.from(state.lfgServers),
                    theme: state.theme,
                    savedPresets: state.savedPresets
                }
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `discord-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const backup = JSON.parse(text);

                    if (!backup.data) {
                        alert('Invalid backup file!');
                        return;
                    }

                    if (!confirm('This will overwrite your current data. Continue?')) {
                        return;
                    }

                    // Restore data
                    state.serverCategories = backup.data.serverCategories || {};
                    state.serverNotes = backup.data.serverNotes || {};
                    state.serverReminders = backup.data.serverReminders || {};
                    state.favoriteServers = new Set(backup.data.favoriteServers || []);
                    state.lastVisited = backup.data.lastVisited || {};
                    state.serverHealth = backup.data.serverHealth || {};
                    state.growthHistory = backup.data.growthHistory || {};
                    state.gameDetections = backup.data.gameDetections || {};
                    state.lfgServers = new Set(backup.data.lfgServers || []);
                    state.theme = backup.data.theme || 'dark';
                    state.savedPresets = backup.data.savedPresets || [];

                    // Save to localStorage
                    saveServerCategories();
                    saveGrowthHistory();
                    savePhase1Data();
                    savePhase3Data();

                    applyTheme();
                    alert('Backup restored successfully!');
                    render();
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Failed to import backup file!');
                }
            };

            input.click();
        }

        // ===== GROWTH DETAILS MODAL =====
        window.showGrowthDetailsModal = function(type) {
            console.log('showGrowthDetailsModal called with type:', type);
            let servers = [];
            let title = '';
            let emoji = '';
            let color = '';
            
            if (type === 'growing') {
                servers = state.servers.filter(s => {
                    const growth = getServerGrowth(s.id);
                    return growth && growth.change > 0;
                }).sort((a, b) => {
                    const growthA = getServerGrowth(a.id);
                    const growthB = getServerGrowth(b.id);
                    return growthB.change - growthA.change;
                });
                title = 'Growing Servers';
                emoji = 'üìà';
                color = 'var(--accent-primary)';
            } else if (type === 'shrinking') {
                servers = state.servers.filter(s => {
                    const growth = getServerGrowth(s.id);
                    return growth && growth.change < 0;
                }).sort((a, b) => {
                    const growthA = getServerGrowth(a.id);
                    const growthB = getServerGrowth(b.id);
                    return growthA.change - growthB.change;
                });
                title = 'Shrinking Servers';
                emoji = 'üìâ';
                color = 'var(--accent-danger)';
            } else if (type === 'stable') {
                servers = state.servers.filter(s => {
                    const growth = getServerGrowth(s.id);
                    return growth && growth.change === 0;
                }).sort((a, b) => b.memberCount - a.memberCount);
                title = 'Stable Servers';
                emoji = '‚û°Ô∏è';
                color = 'var(--text-secondary)';
            }

            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
                        <h2>${emoji} ${title}</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            ${servers.length} server${servers.length !== 1 ? 's' : ''} ${type === 'stable' ? 'with no change' : type}
                        </p>

                        <div style="max-height: 500px; overflow-y: auto;">
                            ${servers.map(server => {
                                const growth = getServerGrowth(server.id);
                                if (!growth) return ''; // Skip if no growth data
                                return `
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: bold; margin-bottom: 0.25rem;">${server.name}</div>
                                                <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                                    Current: ${server.memberCount.toLocaleString()} members
                                                </div>
                                            </div>
                                            <div style="text-align: right; margin-left: 1rem;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: ${color};">
                                                    ${growth.change > 0 ? '+' : ''}${growth.change.toLocaleString()}
                                                </div>
                                                <div style="color: ${color}; font-size: 0.9rem; font-weight: bold;">
                                                    ${growth.percentChange}
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
                                            <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                                Previous: ${growth.oldCount.toLocaleString()} ‚Üí Current: ${growth.newCount.toLocaleString()}
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" onclick="openDiscordServer('${server.id}')">
                                                    Open
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <button class="modal-close" onclick="closeModal()" style="margin-top: 1.5rem;">Close</button>
                    </div>
                </div>
            `;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // ===== PHASE 3: SETTINGS MODAL =====
        function showSettingsModal() {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 700px;">
                        <h2>‚öôÔ∏è Settings</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Customize your Discord Manager experience
                        </p>

                        <!-- Theme Switcher -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">üé® Theme</h3>
                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn ${state.theme === 'dark' ? 'btn-primary' : ''}" onclick="setTheme('dark')" style="flex: 1;">
                                    üåô Dark Mode
                                </button>
                                <button class="btn ${state.theme === 'light' ? 'btn-primary' : ''}" onclick="setTheme('light')" style="flex: 1;">
                                    ‚òÄÔ∏è Light Mode
                                </button>
                            </div>
                        </div>

                        <!-- Backup & Restore -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">üíæ Backup & Restore</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                                Export all your data (categories, notes, favorites, etc.) to a JSON file
                            </p>
                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn btn-primary" onclick="exportAllData()" style="flex: 1;">
                                    üì• Export Backup
                                </button>
                                <button class="btn" onclick="importBackup()" style="flex: 1;">
                                    üì§ Import Backup
                                </button>
                            </div>
                        </div>

                        <!-- Presets -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">üìë Saved Presets</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                                Save your current filters and selections for quick access later
                            </p>
                            
                            <button class="btn btn-primary" onclick="saveCurrentPreset(); closeModal(); setTimeout(() => showSettingsModal(), 200);" style="width: 100%; margin-bottom: 1rem;">
                                üíæ Save Current State as Preset
                            </button>

                            ${state.savedPresets.length > 0 ? `
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${state.savedPresets.map((preset, i) => `
                                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                <div style="font-weight: bold;">${preset.name}</div>
                                                <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                                    ${new Date(preset.timestamp).toLocaleDateString()}
                                                </div>
                                            </div>
                                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.75rem;">
                                                Filter: ${preset.categoryFilter} ‚Ä¢ Sort: ${preset.sortBy} ‚Ä¢ Selected: ${preset.selectedServers.length}
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-primary" onclick="loadPreset(${i}); closeModal();" style="flex: 1;">
                                                    üìÇ Load
                                                </button>
                                                <button class="btn btn-danger" onclick="deletePreset(${i}); closeModal(); setTimeout(() => showSettingsModal(), 200);">
                                                    üóëÔ∏è Delete
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="info-box">
                                    <p><strong>No presets saved yet</strong></p>
                                    <p>Set up your filters and selections, then click "Save Current State"</p>
                                </div>
                            `}
                        </div>

                        <button class="modal-close" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // ===== PHASE 1: QUICK LEAVE WORKFLOW =====
        function startQuickLeave() {
            const selectedArray = Array.from(state.selectedServers);
            const nonOwnedSelected = selectedArray.filter(id => {
                const server = state.servers.find(s => s.id === id);
                return server && !server.owner;
            });

            if (nonOwnedSelected.length === 0) {
                alert('Please select non-owned servers to leave!');
                return;
            }

            if (!confirm(`You're about to leave ${nonOwnedSelected.length} server(s). This will open them in Discord. Continue?`)) {
                return;
            }

            showQuickLeaveModal(nonOwnedSelected);
        }

        function showQuickLeaveModal(serverIds) {
            const servers = serverIds.map(id => state.servers.find(s => s.id === id)).filter(Boolean);
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 700px;">
                        <h2>üö™ Quick Leave Workflow</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Leaving ${servers.length} server(s). Check each one as you leave it.
                        </p>
                        
                        <div style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem;">
                            ${servers.map((s, i) => `
                                <div style="display: flex; align-items: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.75rem;">
                                    <input type="checkbox" id="leave-check-${i}" style="margin-right: 1rem; width: 20px; height: 20px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold;">${s.name}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem;">${s.memberCount.toLocaleString()} members</div>
                                    </div>
                                    <button class="btn btn-primary" onclick="openDiscordServer('${s.id}')">
                                        Open ‚Üí
                                    </button>
                                </div>
                            `).join('')}
                        </div>

                        <div class="modal-steps">
                            <div class="modal-step">
                                <div class="step-number">1</div>
                                <div class="step-text">Click "Open ‚Üí" to open each server</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">2</div>
                                <div class="step-text">Right-click the server icon in Discord</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">3</div>
                                <div class="step-text">Click "Leave Server" and confirm</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">4</div>
                                <div class="step-text">Check the box here after leaving</div>
                            </div>
                        </div>

                        <button class="modal-close" onclick="closeModal()">Done</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // ===== PHASE 1: SERVER DETAILS MODAL =====
        function showServerDetailsModal(serverId) {
            const server = state.servers.find(s => s.id === serverId);
            if (!server) return;

            const note = state.serverNotes[serverId] || '';
            const reminder = state.serverReminders[serverId];
            const health = state.serverHealth[serverId] || { score: 0, issues: [] };
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                        <h2>üìã ${server.name}</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            ${server.memberCount.toLocaleString()} members ${server.owner ? '‚Ä¢ You own this server' : ''}
                        </p>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">üìù Notes</h3>
                            <textarea 
                                id="server-note-input"
                                placeholder="Add personal notes about this server..."
                                style="width: 100%; min-height: 100px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.75rem; border-radius: 8px; font-family: 'Space Mono', monospace; resize: vertical;"
                            >${note}</textarea>
                            <button class="btn btn-primary" onclick="setServerNote('${serverId}', document.getElementById('server-note-input').value); closeModal();" style="margin-top: 0.5rem; width: 100%;">
                                Save Note
                            </button>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">‚è∞ Reminder</h3>
                            ${reminder ? `
                                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                    <div style="font-weight: bold; margin-bottom: 0.25rem;">Set for: ${new Date(reminder.date).toLocaleDateString()}</div>
                                    <div style="color: var(--text-secondary);">${reminder.note}</div>
                                </div>
                                <button class="btn btn-danger" onclick="setServerReminder('${serverId}', null, null); closeModal();" style="width: 100%;">
                                    Remove Reminder
                                </button>
                            ` : `
                                <input type="date" id="reminder-date" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.75rem; border-radius: 8px; font-family: 'Space Mono', monospace; margin-bottom: 0.5rem;">
                                <input type="text" id="reminder-note" placeholder="Reminder message..." style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.75rem; border-radius: 8px; font-family: 'Space Mono', monospace; margin-bottom: 0.5rem;">
                                <button class="btn btn-primary" onclick="setServerReminder('${serverId}', document.getElementById('reminder-date').value, document.getElementById('reminder-note').value); closeModal();" style="width: 100%;">
                                    Set Reminder
                                </button>
                            `}
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">üéÆ Gaming Info</h3>
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                ${state.gameDetections[serverId] ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <strong>Detected Game:</strong> ${state.gameDetections[serverId]}
                                    </div>
                                ` : '<div style="color: var(--text-secondary); margin-bottom: 0.75rem;">No game detected</div>'}
                                <button class="btn ${state.lfgServers.has(serverId) ? 'btn-primary' : ''}" onclick="toggleLFG('${serverId}'); closeModal(); setTimeout(render, 100);" style="width: 100%;">
                                    ${state.lfgServers.has(serverId) ? '‚úì LFG Server (Click to remove)' : 'üë• Mark as LFG Server'}
                                </button>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">
                                    LFG = Looking For Group. Mark servers you use to find teammates.
                                </p>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">üè• Health Score</h3>
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: ${getHealthColor(health.score)}; margin-bottom: 0.5rem;">
                                    ${getHealthLabel(health.score)} - ${health.score}/100
                                </div>
                                ${health.issues.length > 0 ? `
                                    <div style="margin-top: 1rem;">
                                        <strong style="color: var(--text-secondary);">Issues Found:</strong>
                                        <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--text-secondary);">
                                            ${health.issues.map(issue => `<li>${issue}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : '<div style="color: var(--accent-primary);">‚úì No issues found!</div>'}
                            </div>
                        </div>

                        <button class="modal-close" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // ===== PHASE 1: HEALTH MODAL (Quick View) =====
        function showHealthFactorsModal(serverId) {
            const server = state.servers.find(s => s.id === serverId);
            if (!server) return;

            const health = state.serverHealth[serverId] || { score: 0, issues: [] };
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
                        <h2>üè• Health Check</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            ${server.name}
                        </p>

                        <div style="text-align: center; padding: 2rem; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 1.5rem;">
                            <div style="font-size: 3rem; font-weight: bold; color: ${getHealthColor(health.score)};">
                                ${health.score}
                            </div>
                            <div style="font-size: 1.2rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                ${getHealthLabel(health.score)}
                            </div>
                        </div>

                        ${health.issues.length > 0 ? `
                            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                                <strong style="color: var(--accent-warning);">‚ö†Ô∏è Issues Detected:</strong>
                                <ul style="margin: 1rem 0 0 1.5rem; color: var(--text-secondary);">
                                    ${health.issues.map(issue => `<li>${issue}</li>`).join('')}
                                </ul>
                            </div>
                        ` : `
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--accent-primary);">
                                <strong style="color: var(--accent-primary);">‚úì No Issues Found!</strong>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                                    This server is in excellent health. Keep it up!
                                </p>
                            </div>
                        `}

                        <button class="modal-close" onclick="closeModal()" style="margin-top: 1.5rem;">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // ===== DUPLICATE DETECTION =====
        function findDuplicateServers() {
            const duplicates = [];
            const seen = new Map();
            
            state.servers.forEach(server => {
                const nameLower = server.name.toLowerCase().trim();
                
                if (seen.has(nameLower)) {
                    duplicates.push({
                        server1: seen.get(nameLower),
                        server2: server
                    });
                } else {
                    seen.set(nameLower, server);
                }
            });
            
            return duplicates;
        }

        // ===== PERMISSION ANALYSIS =====
        function analyzePermissions(server) {
            const perms = parseInt(server.permissions);
            const risks = [];
            
            // Check for admin permission (0x8)
            if ((perms & 0x8) === 0x8) {
                risks.push({ level: 'high', text: 'Administrator' });
            }
            
            // Check for manage server (0x20)
            if ((perms & 0x20) === 0x20) {
                risks.push({ level: 'medium', text: 'Manage Server' });
            }
            
            // Check for manage roles (0x10000000)
            if ((perms & 0x10000000) === 0x10000000) {
                risks.push({ level: 'medium', text: 'Manage Roles' });
            }
            
            // Check for manage channels (0x10)
            if ((perms & 0x10) === 0x10) {
                risks.push({ level: 'low', text: 'Manage Channels' });
            }
            
            return risks;
        }

        // ===== EXPORT FUNCTIONALITY =====
        function exportToCSV() {
            const headers = ['Server Name', 'Members', 'Owner', 'Categories', 'Member Growth'];
            const rows = state.servers.map(server => {
                const categories = categorizeServer(server).join('; ');
                const growth = getServerGrowth(server.id);
                const growthStr = growth ? `${growth.change} (${growth.percentChange}%)` : 'No data';
                
                return [
                    server.name,
                    server.memberCount,
                    server.owner ? 'Yes' : 'No',
                    categories,
                    growthStr
                ];
            });
            
            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `discord-servers-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToJSON() {
            const data = {
                exportDate: new Date().toISOString(),
                user: state.user.username,
                servers: state.servers.map(server => ({
                    name: server.name,
                    id: server.id,
                    memberCount: server.memberCount,
                    owner: server.owner,
                    categories: categorizeServer(server),
                    growth: getServerGrowth(server.id)
                })),
                connections: state.connections,
                totalServers: state.servers.length
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `discord-data-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===== PHASE 5: PDF EXPORT =====
        function exportToPDF() {
            // Create a comprehensive HTML report
            const stats = {
                total: state.servers.length,
                owned: state.servers.filter(s => s.owner).length,
                favorites: state.favoriteServers.size,
                withNotes: Object.keys(state.serverNotes).length,
                lfg: state.lfgServers.size
            };

            const growingServers = state.servers.filter(s => {
                const growth = getServerGrowth(s.id);
                return growth && growth.change > 0;
            }).length;

            const shrinkingServers = state.servers.filter(s => {
                const growth = getServerGrowth(s.id);
                return growth && growth.change < 0;
            }).length;

            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Discord Manager Report - ${state.user.username}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
        h1 { color: #5865F2; border-bottom: 3px solid #5865F2; padding-bottom: 10px; }
        h2 { color: #23272A; margin-top: 30px; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
        .stat-box { background: #f3f4f6; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; color: #5865F2; }
        .stat-label { color: #666; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #5865F2; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        tr:hover { background: #f9f9f9; }
        .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üìä Discord Manager Report</h1>
    <p><strong>User:</strong> ${state.user.username}${state.user.discriminator !== '0' ? '#' + state.user.discriminator : ''}</p>
    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>

    <h2>üìà Overview</h2>
    <div class="stats">
        <div class="stat-box">
            <div class="stat-value">${stats.total}</div>
            <div class="stat-label">Total Servers</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${stats.owned}</div>
            <div class="stat-label">Servers Owned</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${stats.favorites}</div>
            <div class="stat-label">Favorites</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${growingServers}</div>
            <div class="stat-label">Growing</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${shrinkingServers}</div>
            <div class="stat-label">Shrinking</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${stats.lfg}</div>
            <div class="stat-label">LFG Servers</div>
        </div>
    </div>

    <h2>üéÆ Your Servers</h2>
    <table>
        <thead>
            <tr>
                <th>Server Name</th>
                <th>Members</th>
                <th>Growth</th>
                <th>Health</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            ${state.servers.map(server => {
                const growth = getServerGrowth(server.id);
                const health = state.serverHealth[server.id] || { score: 0 };
                const isFavorite = state.favoriteServers.has(server.id);
                const isLFG = state.lfgServers.has(server.id);
                const game = state.gameDetections[server.id];
                
                return `
                    <tr>
                        <td>
                            ${server.name}
                            ${isFavorite ? ' ‚≠ê' : ''}
                            ${game ? ` (${game})` : ''}
                        </td>
                        <td>${server.memberCount.toLocaleString()}</td>
                        <td>${growth ? (growth.change > 0 ? '+' : '') + growth.change : 'N/A'}</td>
                        <td>${health.score}/100</td>
                        <td>${server.owner ? 'Owner' : isLFG ? 'LFG' : 'Member'}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    </table>

    ${Object.keys(state.serverNotes).length > 0 ? `
        <h2>üìù Server Notes</h2>
        <table>
            <thead>
                <tr>
                    <th>Server</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                ${Object.entries(state.serverNotes).map(([serverId, note]) => {
                    const server = state.servers.find(s => s.id === serverId);
                    return server ? `
                        <tr>
                            <td>${server.name}</td>
                            <td>${note}</td>
                        </tr>
                    ` : '';
                }).join('')}
            </tbody>
        </table>
    ` : ''}

    <div class="footer">
        Generated by Discord Manager ‚Ä¢ ${window.location.origin}
    </div>
</body>
</html>
            `;

            // Create blob and download
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `discord-report-${Date.now()}.html`;
            a.click();
            URL.revokeObjectURL(url);

            alert('üìÑ Report exported! Open the HTML file and print to PDF (Ctrl+P / Cmd+P)');
        }

        // ===== PHASE 5: CALENDAR SYNC (ICS FORMAT) =====
        function exportRemindersToCalendar() {
            const reminders = Object.entries(state.serverReminders);
            
            if (reminders.length === 0) {
                alert('No reminders to export!');
                return;
            }

            // Create ICS calendar file
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Discord Manager//Reminders//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Discord Server Reminders
X-WR-TIMEZONE:UTC
`;

            reminders.forEach(([serverId, reminder]) => {
                const server = state.servers.find(s => s.id === serverId);
                if (!server) return;

                const date = new Date(reminder.date);
                const dateStr = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const uid = `discord-${serverId}-${Date.now()}@discordmanager.com`;

                icsContent += `
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dateStr}
DTSTART:${dateStr}
SUMMARY:Discord: ${server.name}
DESCRIPTION:${reminder.note || 'Server reminder'}
LOCATION:discord://discord.com/channels/${serverId}
STATUS:CONFIRMED
END:VEVENT
`;
            });

            icsContent += `END:VCALENDAR`;

            // Download ICS file
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `discord-reminders-${Date.now()}.ics`;
            a.click();
            URL.revokeObjectURL(url);

            alert(`üìÖ ${reminders.length} reminder(s) exported! Import the .ics file into Google Calendar, Outlook, or Apple Calendar.`);
        }

        // ===== UTILITY FUNCTIONS =====
        function formatDate(date) {
            const now = Date.now();
            const diff = now - new Date(date);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor(diff / (1000 * 60));

            if (days > 30) return `${days} days ago`;
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        function switchTab(tab) {
            state.currentTab = tab;
            state.searchTerm = '';
            render();
        }

        function updateSearch(value) {
            state.searchTerm = value;
            render();
        }

        function updateSort(value) {
            state.sortBy = value;
            render();
        }

        function updateCategoryFilter(category) {
            state.categoryFilter = category;
            render();
        }

        function showPrivacyPolicy() {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
                        <h2>Privacy Policy</h2>
                        <div style="color: var(--text-secondary); max-height: 60vh; overflow-y: auto;">
                            <p style="margin-bottom: 1rem;"><strong>Last Updated:</strong> January 25, 2026</p>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">What We Collect</h3>
                            <p>Discord Manager uses Discord OAuth to access:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Your Discord username and ID</li>
                                <li>List of Discord servers you're in (names, member counts, icons)</li>
                                <li>Your connected accounts (if granted permission)</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">What We DON'T Collect</h3>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Your Discord password (we never see it)</li>
                                <li>Your messages or DMs</li>
                                <li>Any personal information beyond what Discord OAuth provides</li>
                                <li>Analytics or tracking data</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">How We Store Data</h3>
                            <p><strong>On Our Servers:</strong> We DO NOT store any of your Discord data on our servers. All data is fetched in real-time from Discord's API when you login.</p>
                            <p><strong>In Your Browser:</strong> The following is stored locally in your browser using localStorage:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Your server categories (custom tags you create)</li>
                                <li>Server growth snapshots (member count history)</li>
                                <li>Your login token (to keep you logged in)</li>
                            </ul>
                            <p>This data never leaves your computer and can be cleared by logging out or clearing your browser data.</p>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Third-Party Services</h3>
                            <p>We use:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li><strong>Discord OAuth:</strong> For authentication (governed by Discord's privacy policy)</li>
                                <li><strong>Render.com:</strong> For hosting (no user data stored)</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Your Rights</h3>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>You can revoke access anytime in Discord Settings ‚Üí Authorized Apps</li>
                                <li>You can clear all local data by logging out</li>
                                <li>You can export your data using our CSV/JSON export features</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Contact</h3>
                            <p>Questions about privacy? Contact <a href="https://x.com/ObiWanBENobiETH" target="_blank" style="color: var(--accent-secondary);">@ObiWanBENobiETH on Twitter/X</a></p>
                        </div>
                        <button class="modal-close" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function showTerms() {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
                        <h2>Terms of Service</h2>
                        <div style="color: var(--text-secondary); max-height: 60vh; overflow-y: auto;">
                            <p style="margin-bottom: 1rem;"><strong>Last Updated:</strong> January 25, 2026</p>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Acceptance of Terms</h3>
                            <p>By using Discord Manager, you agree to these terms. If you don't agree, please don't use the service.</p>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Description of Service</h3>
                            <p>Discord Manager is a free tool that helps you organize and manage your Discord servers. It provides:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Server categorization and organization</li>
                                <li>Growth tracking and analytics</li>
                                <li>Bulk management tools</li>
                                <li>Data export capabilities</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">User Responsibilities</h3>
                            <p>You agree to:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Use the service in compliance with Discord's Terms of Service</li>
                                <li>Not use the service for any illegal purposes</li>
                                <li>Not attempt to hack, exploit, or abuse the service</li>
                                <li>Not use automated tools to access the service excessively</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Disclaimer</h3>
                            <p><strong>Discord Manager is provided "as is" without warranties of any kind.</strong></p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>We are not affiliated with Discord Inc.</li>
                                <li>We don't guarantee 100% uptime or availability</li>
                                <li>Server growth data is approximate and based on available information</li>
                                <li>Activity data is simulated for demonstration purposes</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Limitation of Liability</h3>
                            <p>We are not responsible for:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Loss of data stored in your browser</li>
                                <li>Any actions you take based on the information provided</li>
                                <li>Issues arising from Discord API changes</li>
                                <li>Any damages resulting from use of the service</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Changes to Service</h3>
                            <p>We reserve the right to:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Modify or discontinue the service at any time</li>
                                <li>Update these terms with notice</li>
                                <li>Change features or functionality</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Contact</h3>
                            <p>Questions about these terms? Contact <a href="https://x.com/ObiWanBENobiETH" target="_blank" style="color: var(--accent-secondary);">@ObiWanBENobiETH on Twitter/X</a></p>
                        </div>
                        <button class="modal-close" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function showCategoryModal(serverId, serverName) {
            const server = state.servers.find(s => s.id === serverId);
            const currentCategories = state.serverCategories[serverId] || [];
            const suggestions = getSuggestedCategories(server);
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h2>üìÅ Categorize Server</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            <strong>${serverName}</strong>
                        </p>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">Select Categories:</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                ${Object.entries(CATEGORIES).map(([key, cat]) => {
                                    const isSelected = currentCategories.includes(key);
                                    const isSuggested = suggestions.includes(key);
                                    return `
                                        <button 
                                            class="btn ${isSelected ? 'btn-primary' : ''}" 
                                            onclick="toggleServerCategory('${serverId}', '${key}')"
                                            style="text-align: left; position: relative;">
                                            ${cat.emoji} ${cat.label}
                                            ${isSuggested && !isSelected ? '<span style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--accent-secondary);">suggested</span>' : ''}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        ${suggestions.length > 0 ? `
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    üí° <strong>Suggestions based on server name/size:</strong><br>
                                    ${suggestions.map(s => CATEGORIES[s].emoji + ' ' + CATEGORIES[s].label).join(', ')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <button class="modal-close" onclick="closeModal()">Done</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function showBulkCategoryModal() {
            if (state.selectedServers.size === 0) {
                alert('Please select servers first!');
                return;
            }
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h2>üìÅ Bulk Categorize</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Add category to ${state.selectedServers.size} selected server${state.selectedServers.size > 1 ? 's' : ''}
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            ${Object.entries(CATEGORIES).map(([key, cat]) => `
                                <button 
                                    class="btn btn-primary" 
                                    onclick="bulkCategorize('${key}'); closeModal();"
                                    style="text-align: left;">
                                    ${cat.emoji} ${cat.label}
                                </button>
                            `).join('')}
                        </div>
                        
                        <button class="modal-close" onclick="closeModal()" style="margin-top: 1rem;">Cancel</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function closeModal() {
            const modal = document.getElementById('instruction-modal');
            if (modal) modal.remove();
        }

        // ===== SERVER FUNCTIONS =====
        function getFilteredServers() {
            let filtered = state.servers.filter(s => 
                s.name.toLowerCase().includes(state.searchTerm.toLowerCase())
            );
            
            // Category filter
            if (state.categoryFilter === 'favorites') {
                filtered = filtered.filter(s => state.favoriteServers.has(s.id));
            } else if (state.categoryFilter !== 'all') {
                filtered = filtered.filter(s => 
                    categorizeServer(s).includes(state.categoryFilter)
                );
            }
            
            // Sort
            return filtered.sort((a, b) => {
                if (state.sortBy === 'members') return b.memberCount - a.memberCount;
                if (state.sortBy === 'name') return a.name.localeCompare(b.name);
                if (state.sortBy === 'health') {
                    const healthA = state.serverHealth[a.id]?.score || 0;
                    const healthB = state.serverHealth[b.id]?.score || 0;
                    return healthB - healthA;
                }
                if (state.sortBy === 'visited') {
                    const visitedA = state.lastVisited[a.id] || 0;
                    const visitedB = state.lastVisited[b.id] || 0;
                    return visitedB - visitedA;
                }
                if (state.sortBy === 'growth') {
                    const growthA = getServerGrowth(a.id);
                    const growthB = getServerGrowth(b.id);
                    if (!growthA && !growthB) return 0;
                    if (!growthA) return 1;
                    if (!growthB) return -1;
                    return growthB.change - growthA.change;
                }
                return 0;
            });
        }

        function getServerStats() {
            return {
                total: state.servers.length,
                owned: state.servers.filter(s => s.owner).length,
                selected: state.selectedServers.size,
                large: state.servers.filter(s => s.memberCount > 5000).length,
                small: state.servers.filter(s => s.memberCount < 100).length
            };
        }

        function toggleServer(serverId) {
            if (state.selectedServers.has(serverId)) {
                state.selectedServers.delete(serverId);
            } else {
                state.selectedServers.add(serverId);
            }
            render();
        }

        function selectByCategory(category) {
            const servers = state.servers.filter(s => 
                categorizeServer(s).includes(category)
            );
            state.selectedServers = new Set(servers.map(s => s.id));
            render();
        }

        function selectAll() {
            state.selectedServers = new Set(state.servers.map(s => s.id));
            render();
        }

        function deselectAll() {
            state.selectedServers = new Set();
            render();
        }

        function openSelectedServers() {
            if (state.selectedServers.size === 0) return;
            
            const selectedArray = Array.from(state.selectedServers);
            
            if (selectedArray.length > 10) {
                if (!confirm(`This will open ${selectedArray.length} Discord tabs. Are you sure?`)) {
                    return;
                }
            }
            
            selectedArray.forEach(serverId => {
                window.open(`discord://discord.com/channels/${serverId}`, '_blank');
            });
            
            showLeaveServerInstructions(selectedArray.length);
        }

        function openServerWithInstructions(serverId, serverName) {
            window.open(`discord://discord.com/channels/${serverId}`, '_blank');
            showLeaveServerInstructions(1, serverName);
        }

        function showLeaveServerInstructions(count, serverName) {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h2>üìç Discord Opened!</h2>
                        ${serverName ? `<p class="server-opened">Server: ${serverName}</p>` : `<p class="server-opened">${count} server(s) opened in new tab(s)</p>`}
                        <div class="modal-steps">
                            <div class="modal-step">
                                <div class="step-number">1</div>
                                <div class="step-text">Find the server icon in the left sidebar of Discord</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">2</div>
                                <div class="step-text">Right-click the server icon</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">3</div>
                                <div class="step-text">Click "Leave Server" in the menu</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">4</div>
                                <div class="step-text">Confirm by clicking "Leave Server" again</div>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()">Got it!</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function showDuplicateModal() {
            const duplicates = findDuplicateServers();
            
            if (duplicates.length === 0) {
                alert('No duplicate servers found!');
                return;
            }
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h2>üîç Duplicate Servers Found</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Found ${duplicates.length} potential duplicate${duplicates.length > 1 ? 's' : ''}. You might be in these servers multiple times.
                        </p>
                        ${duplicates.map(dup => `
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">${dup.server1.name}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Server 1: ${dup.server1.memberCount.toLocaleString()} members
                                    <br>
                                    Server 2: ${dup.server2.memberCount.toLocaleString()} members
                                </div>
                            </div>
                        `).join('')}
                        <button class="modal-close" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // ===== RENDER FUNCTIONS =====

        // ===== ENHANCED FEATURE 1: DETAILED PERMISSION ANALYZER =====
        function getPermissionDetails() {
            const permissionBreakdown = {
                administrator: [],
                manageServer: [],
                manageRoles: [],
                manageChannels: [],
                kickMembers: [],
                banMembers: [],
                manageMessages: [],
                mentionEveryone: [],
                viewAuditLog: []
            };

            state.servers.forEach(server => {
                const permissions = parseInt(server.permissions);
                
                if (permissions & 0x8) permissionBreakdown.administrator.push(server);
                if (permissions & 0x20) permissionBreakdown.manageServer.push(server);
                if (permissions & 0x10000000) permissionBreakdown.manageRoles.push(server);
                if (permissions & 0x10) permissionBreakdown.manageChannels.push(server);
                if (permissions & 0x2) permissionBreakdown.kickMembers.push(server);
                if (permissions & 0x4) permissionBreakdown.banMembers.push(server);
                if (permissions & 0x2000) permissionBreakdown.manageMessages.push(server);
                if (permissions & 0x20000) permissionBreakdown.mentionEveryone.push(server);
                if (permissions & 0x80) permissionBreakdown.viewAuditLog.push(server);
            });

            return permissionBreakdown;
        }

        function showDetailedPermissionsModal() {
            const perms = getPermissionDetails();
            const totalDangerousPerms = perms.administrator.length + perms.manageServer.length + 
                                        perms.banMembers.length + perms.manageRoles.length;
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 900px;">
                        <h2>üîê Detailed Permission Analysis</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Comprehensive breakdown of ALL your permissions across ${state.servers.length} servers
                        </p>

                        ${totalDangerousPerms > 0 ? `
                            <div class="warning-box" style="margin-bottom: 1.5rem;">
                                <strong>‚ö†Ô∏è Security Alert:</strong> You have dangerous permissions in ${totalDangerousPerms} server(s). 
                                Review these carefully to ensure you trust them.
                            </div>
                        ` : ''}

                        <div style="max-height: 60vh; overflow-y: auto;">
                            ${renderPermissionSection('Administrator', 'üëë', perms.administrator, 'Full control over the server', 'danger')}
                            ${renderPermissionSection('Manage Server', '‚öôÔ∏è', perms.manageServer, 'Change server settings', 'danger')}
                            ${renderPermissionSection('Manage Roles', 'üé≠', perms.manageRoles, 'Create and edit roles', 'warning')}
                            ${renderPermissionSection('Ban Members', 'üî®', perms.banMembers, 'Ban users from server', 'warning')}
                            ${renderPermissionSection('Kick Members', 'üë¢', perms.kickMembers, 'Remove users from server', 'warning')}
                            ${renderPermissionSection('Manage Channels', 'üìù', perms.manageChannels, 'Create and edit channels', 'secondary')}
                            ${renderPermissionSection('View Audit Log', 'üìú', perms.viewAuditLog, 'View server audit logs', 'secondary')}
                            ${renderPermissionSection('Manage Messages', 'üí¨', perms.manageMessages, 'Delete others messages', 'secondary')}
                            ${renderPermissionSection('Mention Everyone', 'üì¢', perms.mentionEveryone, 'Ping @everyone', 'secondary')}
                        </div>

                        <button class="modal-close" onclick="closeModal()" style="margin-top: 1.5rem;">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function renderPermissionSection(title, emoji, servers, description, badgeType) {
            if (servers.length === 0) return '';
            
            return `
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3 style="color: var(--accent-primary); margin-bottom: 0.25rem;">
                                ${emoji} ${title}
                            </h3>
                            <p style="color: var(--text-secondary); font-size: 0.85rem;">${description}</p>
                        </div>
                        <span class="badge badge-${badgeType}" style="font-size: 1.1rem; padding: 0.5rem 1rem;">
                            ${servers.length}
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem; max-height: 150px; overflow-y: auto;">
                        ${servers.map(s => `
                            <div style="background: var(--bg-card); padding: 0.75rem; border-radius: 6px; font-size: 0.9rem;">
                                <div style="font-weight: bold; margin-bottom: 0.25rem;">${s.name}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">
                                    ${s.memberCount.toLocaleString()} members
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ===== ENHANCED FEATURE 2: ADVANCED SERVER COMPARISON =====
        function showAdvancedComparisonModal() {
            const selectedArray = Array.from(state.selectedServers);
            
            if (selectedArray.length < 2) {
                alert('Select at least 2 servers to compare!');
                return;
            }

            const servers = selectedArray
                .map(id => state.servers.find(s => s.id === id))
                .filter(Boolean);

            // Calculate metrics for comparison
            const metrics = servers.map(s => {
                const health = (state.serverHealth && state.serverHealth[s.id]) || { score: 0 };
                const growth = getServerGrowth(s.id);
                const perms = analyzePermissions(s);
                const categories = categorizeServer(s);
                
                return {
                    server: s,
                    health: health.score,
                    growth: growth ? growth.percentChange : 0,
                    hasAdminPerms: perms.some(p => p.level === 'high'),
                    categoryCount: categories.length,
                    isOwner: s.owner,
                    isFavorite: state.favoriteServers && state.favoriteServers.has(s.id),
                    hasNotes: state.serverNotes && !!state.serverNotes[s.id]
                };
            });

            // Find the "best" server
            const bestServer = metrics.reduce((best, current) => {
                let score = 0;
                if (current.health > best.health) score += 3;
                if (current.server.memberCount > best.server.memberCount) score += 2;
                if (current.growth > best.growth) score += 1;
                if (current.isFavorite && !best.isFavorite) score += 2;
                return score > 0 ? current : best;
            }, metrics[0]);

            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 1000px;">
                        <h2>‚öñÔ∏è Advanced Server Comparison</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Comparing ${servers.length} servers side-by-side
                        </p>

                        ${bestServer ? `
                            <div class="info-box" style="margin-bottom: 1.5rem; border: 2px solid var(--accent-primary);">
                                <strong>üèÜ Recommended: ${bestServer.server.name}</strong>
                                <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                                    Based on health score, size, and growth trends, this appears to be the most active/valuable server.
                                </p>
                            </div>
                        ` : ''}

                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-secondary);">
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid var(--border); min-width: 150px;">Metric</th>
                                        ${servers.map(s => `
                                            <th style="padding: 0.75rem; text-align: center; border: 1px solid var(--border); min-width: 200px;">
                                                ${s.id === bestServer.server.id ? 'üèÜ ' : ''}${s.name}
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${renderComparisonRow('üë• Members', servers, s => s.memberCount.toLocaleString(), true)}
                                    ${renderComparisonRow('üè• Health Score', metrics, m => m.health + '/100', true)}
                                    ${renderComparisonRow('üìà Growth', metrics, m => {
                                        const g = getServerGrowth(m.server.id);
                                        return g ? `${g.change > 0 ? '+' : ''}${g.percentChange}%` : 'No data';
                                    })}
                                    ${renderComparisonRow('üëë Owner', servers, s => s.owner ? '‚úÖ Yes' : '‚ùå No')}
                                    ${renderComparisonRow('üîê Admin Perms', metrics, m => m.hasAdminPerms ? '‚ö†Ô∏è Yes' : '‚úÖ No')}
                                    ${renderComparisonRow('‚≠ê Favorite', metrics, m => m.isFavorite ? '‚úÖ Yes' : '‚ùå No')}
                                    ${renderComparisonRow('üìù Has Notes', metrics, m => m.hasNotes ? '‚úÖ Yes' : '‚ùå No')}
                                    ${renderComparisonRow('üìÅ Categories', metrics, m => m.categoryCount)}
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                            <button class="btn" onclick="clearComparison(); closeModal(); render();" style="flex: 1;">
                                Clear Comparison
                            </button>
                            <button class="modal-close" onclick="closeModal()" style="flex: 1;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function renderComparisonRow(label, items, getValue, highlightMax = false) {
            const values = items.map(getValue);
            const maxValue = highlightMax ? Math.max(...values.map(v => typeof v === 'string' ? parseFloat(v.replace(/[^0-9.-]/g, '')) || 0 : v)) : null;
            
            return `
                <tr>
                    <td style="padding: 0.75rem; border: 1px solid var(--border); font-weight: bold;">${label}</td>
                    ${values.map((v, i) => {
                        const numValue = typeof v === 'string' ? parseFloat(v.replace(/[^0-9.-]/g, '')) || 0 : v;
                        const isMax = highlightMax && numValue === maxValue && maxValue > 0;
                        return `
                            <td style="padding: 0.75rem; text-align: center; border: 1px solid var(--border); ${isMax ? 'background: rgba(0, 255, 136, 0.1); font-weight: bold; color: var(--accent-primary);' : ''}">
                                ${v}
                            </td>
                        `;
                    }).join('')}
                </tr>
            `;
        }

        // ===== ENHANCED FEATURE 3: COMPREHENSIVE DATA EXPORT =====
        function exportComprehensiveData() {
            try {
                const data = {
                    exportDate: new Date().toISOString(),
                    exportVersion: '2.0',
                    user: {
                        id: state.user.id,
                        username: state.user.username,
                        discriminator: state.user.discriminator,
                        avatar: state.user.avatar
                    },
                    servers: state.servers.map(server => {
                        const health = (state.serverHealth && state.serverHealth[server.id]) || { score: 0, issues: [], factors: [] };
                        const growth = getServerGrowth(server.id);
                        const permissions = analyzePermissions(server);
                        
                        return {
                            id: server.id,
                            name: server.name,
                            icon: server.icon,
                            memberCount: server.memberCount,
                            owner: server.owner,
                            permissions: permissions.map(p => p.text),
                            categories: categorizeServer(server),
                            healthScore: health.score,
                            healthIssues: health.issues || [],
                            growth: growth,
                            favorite: state.favoriteServers && state.favoriteServers.has(server.id),
                            notes: (state.serverNotes && state.serverNotes[server.id]) || null,
                            reminder: (state.serverReminders && state.serverReminders[server.id]) || null,
                            lfgServer: state.lfgServers && state.lfgServers.has(server.id),
                            detectedGame: (state.gameDetections && state.gameDetections[server.id]) || null,
                            visitHistory: (state.visitHistory && state.visitHistory[server.id]) || []
                        };
                    }),
                    connections: state.connections.map(c => ({
                        type: c.type,
                        name: c.name,
                        verified: c.verified
                    })),
                    statistics: {
                        totalServers: state.servers.length,
                        ownedServers: state.servers.filter(s => s.owner).length,
                        largeServers: state.servers.filter(s => s.memberCount >= 5000).length,
                        smallServers: state.servers.filter(s => s.memberCount < 100).length,
                        favoriteServers: (state.favoriteServers && state.favoriteServers.size) || 0,
                        categorizedServers: (state.serverCategories && Object.keys(state.serverCategories).length) || 0,
                        serversWithNotes: (state.serverNotes && Object.keys(state.serverNotes).length) || 0,
                        lfgServers: (state.lfgServers && state.lfgServers.size) || 0,
                        adminServers: state.servers.filter(s => {
                            const perms = analyzePermissions(s);
                            return perms.some(p => p.level === 'high');
                        }).length
                    },
                    permissions: getPermissionDetails(),
                    growthTracking: {
                        lastSnapshot: state.lastSnapshot || null,
                        totalSnapshots: (state.growthHistory && Object.values(state.growthHistory).reduce((sum, h) => sum + h.length, 0)) || 0,
                        trackedServers: (state.growthHistory && Object.keys(state.growthHistory).length) || 0
                    }
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `discord-complete-export-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ Comprehensive export complete!

Exported data includes:
‚Ä¢ ${data.servers.length} servers with full details
‚Ä¢ ${data.connections.length} connected accounts
‚Ä¢ ${(state.serverCategories && Object.keys(state.serverCategories).length) || 0} categorized servers
‚Ä¢ ${(state.serverNotes && Object.keys(state.serverNotes).length) || 0} server notes
‚Ä¢ Growth tracking data
‚Ä¢ Permission analysis
‚Ä¢ And much more!`);
            } catch (error) {
                console.error('Export error:', error);
                alert(`‚ùå Export failed: ${error.message}\n\nPlease check the console for details.`);
            }
        }

        // ===== ENHANCED FEATURE 5: BETTER HEALTH SCORES =====
        function calculateEnhancedHealth(serverId) {
            const server = state.servers.find(s => s.id === serverId);
            if (!server) return { score: 0, issues: [], factors: [] };
            
            let score = 50; // Base score
            const issues = [];
            const factors = [];
            
            // Member count (max +30)
            if (server.memberCount >= 10000) {
                score += 30;
                factors.push({ text: 'Very large community', points: 30 });
            } else if (server.memberCount >= 1000) {
                score += 20;
                factors.push({ text: 'Large community', points: 20 });
            } else if (server.memberCount >= 100) {
                score += 10;
                factors.push({ text: 'Medium community', points: 10 });
            } else if (server.memberCount < 10) {
                score -= 20;
                issues.push('Very small server (< 10 members)');
                factors.push({ text: 'Very small community', points: -20 });
            } else if (server.memberCount < 50) {
                score -= 10;
                issues.push('Small server (< 50 members)');
                factors.push({ text: 'Small community', points: -10 });
            }
            
            // Growth trend (max ¬±20)
            const growth = getServerGrowth(serverId);
            if (growth) {
                if (growth.change > 100) {
                    score += 20;
                    factors.push({ text: 'Rapid growth', points: 20 });
                } else if (growth.change > 0) {
                    score += 10;
                    factors.push({ text: 'Growing', points: 10 });
                } else if (growth.change < -100) {
                    score -= 20;
                    issues.push('Rapidly losing members');
                    factors.push({ text: 'Rapid decline', points: -20 });
                } else if (growth.change < 0) {
                    score -= 10;
                    issues.push('Losing members');
                    factors.push({ text: 'Declining', points: -10 });
                }
            }
            
            // Ownership (+15)
            if (server.owner) {
                score += 15;
                factors.push({ text: 'You own this server', points: 15 });
            }
            
            // Favorite (+10)
            if (state.favoriteServers.has(serverId)) {
                score += 10;
                factors.push({ text: 'Marked as favorite', points: 10 });
            }
            
            // Has notes (+5)
            if (state.serverNotes[serverId]) {
                score += 5;
                factors.push({ text: 'Has personal notes', points: 5 });
            }
            
            // Last visited (max ¬±15)
            const daysSinceVisit = getDaysSinceVisit(serverId);
            if (daysSinceVisit !== null) {
                if (daysSinceVisit > 180) {
                    score -= 15;
                    issues.push('Not visited in 6+ months');
                    factors.push({ text: 'Inactive (6+ months)', points: -15 });
                } else if (daysSinceVisit > 90) {
                    score -= 10;
                    issues.push('Not visited in 3+ months');
                    factors.push({ text: 'Inactive (3+ months)', points: -10 });
                } else if (daysSinceVisit > 30) {
                    score -= 5;
                    issues.push('Not visited recently');
                    factors.push({ text: 'Not visited in 30+ days', points: -5 });
                } else if (daysSinceVisit <= 7) {
                    score += 10;
                    factors.push({ text: 'Recently active', points: 10 });
                }
            }
            
            // Admin permissions (risky -5)
            const perms = analyzePermissions(server);
            if (perms.some(p => p.level === 'high') && !server.owner) {
                score -= 5;
                issues.push('Has elevated permissions');
                factors.push({ text: 'Security risk (admin perms)', points: -5 });
            }
            
            // Clamp score between 0-100
            score = Math.max(0, Math.min(100, Math.round(score)));
            
            return { score, issues, factors };
        }

        function showHealthFactorsModal(serverId) {
            const server = state.servers.find(s => s.id === serverId);
            if (!server) return;

            const health = calculateEnhancedHealth(serverId);

            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 700px;">
                        <h2>üè• Health Score Breakdown</h2>
                        <h3 style="color: var(--text-secondary); margin-bottom: 1.5rem;">${server.name}</h3>

                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="font-size: 4rem; font-weight: bold; color: ${getHealthColor(health.score)};">
                                ${health.score}
                            </div>
                            <div style="font-size: 1.5rem; color: var(--text-secondary);">
                                ${getHealthLabel(health.score)}
                            </div>
                        </div>

                        ${health.factors.length > 0 ? `
                            <div style="margin-bottom: 2rem;">
                                <h3 style="color: var(--accent-primary); margin-bottom: 1rem;">üìä Score Factors</h3>
                                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                    ${health.factors.map(f => `
                                        <div style="display: flex; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid var(--border); align-items: center;">
                                            <span>${f.text}</span>
                                            <span style="font-weight: bold; color: ${f.points > 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'};">
                                                ${f.points > 0 ? '+' : ''}${f.points}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${health.issues.length > 0 ? `
                            <div class="warning-box">
                                <strong>‚ö†Ô∏è Issues Detected:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${health.issues.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        <button class="modal-close" onclick="closeModal()" style="margin-top: 1.5rem;">Close</button>
                    </div>
                </div>
            `;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function renderServersTab() {
            const stats = getServerStats();
            const filtered = getFilteredServers();

            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total Servers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.owned}</div>
                        <div class="stat-label">You Own</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.large}</div>
                        <div class="stat-label">Large (5000+)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.small}</div>
                        <div class="stat-label">Small (<100)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.selected}</div>
                        <div class="stat-label">Selected</div>
                    </div>
                </div>

                <div class="category-filter">
                    <div class="category-chip ${state.categoryFilter === 'all' ? 'active' : ''}" onclick="updateCategoryFilter('all')">
                        All Servers
                    </div>
                    <div class="category-chip ${state.categoryFilter === 'favorites' ? 'active' : ''}" onclick="updateCategoryFilter('favorites')">
                        ‚≠ê Favorites (${state.favoriteServers.size})
                    </div>
                    <div class="category-chip ${state.categoryFilter === 'uncategorized' ? 'active' : ''}" onclick="updateCategoryFilter('uncategorized')">
                        ‚ùì Uncategorized
                    </div>
                    ${Object.entries(CATEGORIES).map(([key, cat]) => `
                        <div class="category-chip ${state.categoryFilter === key ? 'active' : ''}" onclick="updateCategoryFilter('${key}')">
                            ${cat.emoji} ${cat.label}
                        </div>
                    `).join('')}
                    <div class="category-chip ${state.categoryFilter === 'large' ? 'active' : ''}" onclick="updateCategoryFilter('large')">
                        üèÜ Large (5000+)
                    </div>
                    <div class="category-chip ${state.categoryFilter === 'owned' ? 'active' : ''}" onclick="updateCategoryFilter('owned')">
                        üëë Owned
                    </div>
                </div>

                <div class="controls">
                    <input type="text" class="search-box" placeholder="Search servers..." value="${state.searchTerm}" oninput="updateSearch(this.value)"/>
                    <select class="btn" onchange="updateSort(this.value)">
                        <option value="name" ${state.sortBy === 'name' ? 'selected' : ''}>Name (A-Z)</option>
                        <option value="members" ${state.sortBy === 'members' ? 'selected' : ''}>Member Count</option>
                        <option value="growth" ${state.sortBy === 'growth' ? 'selected' : ''}>Growth</option>
                        <option value="health" ${state.sortBy === 'health' ? 'selected' : ''}>Health Score</option>
                        <option value="visited" ${state.sortBy === 'visited' ? 'selected' : ''}>Last Visited</option>
                    </select>
                    <button class="btn" onclick="selectAll()">Select All</button>
                    <button class="btn" onclick="deselectAll()">Deselect All</button>
                    <button class="btn" onclick="showBulkCategoryModal()" ${stats.selected === 0 ? 'disabled' : ''}>
                        üìÅ Categorize ${stats.selected}
                    </button>
                    <button class="btn" onclick="showAdvancedComparisonModal()" ${stats.selected < 2 ? 'disabled' : ''} title="${stats.selected < 2 ? 'Select at least 2 servers to compare' : 'Compare selected servers'}">
                        ‚öñÔ∏è Compare ${stats.selected > 0 ? stats.selected : ''}
                    </button>
                    <button class="btn btn-danger" onclick="startQuickLeave()" ${stats.selected === 0 ? 'disabled' : ''}>
                        üö™ Quick Leave ${stats.selected}
                    </button>
                    <button class="btn btn-primary" onclick="openSelectedServers()" ${stats.selected === 0 ? 'disabled' : ''}>
                        Open ${stats.selected} Selected
                    </button>
                </div>

                <div class="item-list">
                    ${filtered.map((server, i) => {
                        const isSelected = state.selectedServers.has(server.id);
                        const categories = categorizeServer(server);
                        const growth = getServerGrowth(server.id);
                        const permissions = analyzePermissions(server);
                        const isFavorite = state.favoriteServers.has(server.id);
                        const health = state.serverHealth[server.id] || { score: 0, issues: [] };
                        const hasNote = !!state.serverNotes[server.id];
                        const hasReminder = !!state.serverReminders[server.id];
                        const daysSinceVisit = getDaysSinceVisit(server.id);

                        return `
                            <div class="item-card ${isSelected ? 'selected' : ''}" style="animation-delay: ${i * 0.05}s">
                                <div class="item-header" style="position: relative;">
                                    <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleServer('${server.id}')"/>
                                    <div class="item-icon">
                                        ${server.icon ? `<img src="${server.icon}" alt="${server.name}">` : server.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="item-info">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div class="item-name">${server.name}</div>
                                            <button 
                                                onclick="event.stopPropagation(); toggleFavorite('${server.id}')" 
                                                style="background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0.25rem;"
                                                title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                                                ${isFavorite ? '‚≠ê' : '‚òÜ'}
                                            </button>
                                            ${hasNote ? `
                                                <span style="cursor: pointer; font-size: 1rem;" onclick="event.stopPropagation(); showServerDetailsModal('${server.id}')" title="Has notes">
                                                    üìù
                                                </span>
                                            ` : ''}
                                            ${hasReminder ? `
                                                <span style="cursor: pointer; font-size: 1rem;" onclick="event.stopPropagation(); showServerDetailsModal('${server.id}')" title="Has reminder">
                                                    ‚è∞
                                                </span>
                                            ` : ''}
                                        </div>
                                        <div class="item-subtitle">
                                            ${server.memberCount.toLocaleString()} members
                                            ${server.owner ? ' ‚Ä¢ Owner' : ''}
                                            ${state.gameDetections[server.id] ? ` ‚Ä¢ üéÆ ${state.gameDetections[server.id]}` : ''}
                                            ${state.lfgServers.has(server.id) ? ' ‚Ä¢ üë• LFG' : ''}
                                            ${growth ? ` ‚Ä¢ ${growth.trending === 'up' ? 'üìà' : growth.trending === 'down' ? 'üìâ' : '‚û°Ô∏è'} ${growth.percentChange}%` : ''}
                                            ${daysSinceVisit !== null ? ` ‚Ä¢ Visited ${daysSinceVisit === 0 ? 'today' : daysSinceVisit + 'd ago'}` : ' ‚Ä¢ Never tracked'}
                                        </div>
                                        <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                            ${state.showHealthScores ? `
                                                <span class="badge" style="background: ${getHealthColor(health.score)}20; border: 1px solid ${getHealthColor(health.score)}; color: ${getHealthColor(health.score)};" onclick="event.stopPropagation(); showHealthFactorsModal('${server.id}')" title="Click for details">
                                                    ${getHealthLabel(health.score)} ${health.score}
                                                </span>
                                            ` : ''}
                                            ${categories.filter(c => c !== 'owned' && c !== 'large').map(cat => {
                                                if (cat === 'uncategorized') {
                                                    return `<span class="badge badge-secondary">‚ùì Uncategorized</span>`;
                                                }
                                                const catInfo = CATEGORIES[cat];
                                                return catInfo ? `<span class="badge badge-primary">${catInfo.emoji} ${catInfo.label}</span>` : '';
                                            }).join('')}
                                            ${categories.includes('large') ? `<span class="badge badge-danger">üèÜ Large</span>` : ''}
                                            ${permissions.length > 0 ? `<span class="badge badge-${permissions[0].level === 'high' ? 'danger' : 'warning'}">‚ö†Ô∏è ${permissions[0].text}</span>` : ''}
                                            <button class="badge badge-secondary" onclick="event.stopPropagation(); showCategoryModal('${server.id}', '${server.name.replace(/'/g, "\\'")}');" style="cursor: pointer; border: 1px dashed var(--border); background: transparent;">
                                                + Category
                                            </button>
                                            <button class="badge badge-secondary" onclick="event.stopPropagation(); showServerDetailsModal('${server.id}');" style="cursor: pointer; border: 1px dashed var(--border); background: transparent;">
                                                üìù Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button class="btn" style="flex: 1;" onclick="openDiscordServer('${server.id}')">
                                        Open in Discord
                                    </button>
                                    ${!server.owner ? `
                                        <button class="btn btn-danger" onclick="openServerWithInstructions('${server.id}', '${server.name.replace(/'/g, "\\'")}')">
                                            Leave Server
                                        </button>
                                    ` : `
                                        <button class="btn" disabled title="You own this server">Owner</button>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderAnalyticsTab() {
            const roleMap = getAllRoles();

            return `
                <div class="insight-grid">
                    <!-- Role Analyzer -->
                    <div class="insight-section">
                        <h3>üë§ Role & Permission Analyzer</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            All roles and permissions across your servers (REAL DATA)
                        </p>

                        <div class="stats-grid" style="margin-bottom: 1.5rem;">
                            <div class="stat-card">
                                <div class="stat-value">${roleMap.size}</div>
                                <div class="stat-label">Unique Roles</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${state.servers.filter(s => s.owner).length}</div>
                                <div class="stat-label">Server Owner</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${Array.from(roleMap.values()).filter(servers => servers.some(s => s.level === 'high')).length}</div>
                                <div class="stat-label">Admin Roles</div>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="showDetailedPermissionsModal()" style="width: 100%; margin-bottom: 1.5rem;">
                            üîç View Detailed Permission Breakdown
                        </button>
                        <h4 style="color: var(--accent-primary); margin-bottom: 1rem;">Your Roles:</h4>
                        ${Array.from(roleMap.entries()).map(([role, servers]) => {
                            const highestLevel = servers.some(s => s.level === 'high') ? 'high' : servers.some(s => s.level === 'medium') ? 'medium' : 'low';
                            const badgeColor = highestLevel === 'high' ? 'danger' : highestLevel === 'medium' ? 'warning' : 'secondary';
                            
                            return `
                                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="font-weight: bold;">${role}</div>
                                        <span class="badge badge-${badgeColor}">${servers.length} server${servers.length > 1 ? 's' : ''}</span>
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                        ${servers.slice(0, 3).map(s => s.serverName).join(', ')}
                                        ${servers.length > 3 ? ` +${servers.length - 3} more` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Coming Soon -->
                    <div class="insight-section">
                        <h3>üöÄ Coming Soon: Real Activity Tracking</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Future features will include browser extension for REAL data
                        </p>

                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                            <h4 style="color: var(--accent-primary); margin-bottom: 1rem;">üì± Browser Extension (Phase 6)</h4>
                            <ul style="color: var(--text-secondary); line-height: 1.8;">
                                <li>‚úÖ <strong>Real notification tracking</strong> - Actual count, not estimates</li>
                                <li>‚úÖ <strong>Activity heatmap</strong> - GitHub-style visualization</li>
                                <li>‚úÖ <strong>Message analytics</strong> - Which servers you actually use</li>
                                <li>‚úÖ <strong>Time tracking</strong> - How long you spend in each server</li>
                                <li>‚úÖ <strong>DM analytics</strong> - Private message patterns</li>
                            </ul>
                            <p style="color: var(--accent-secondary); margin-top: 1rem; font-weight: bold;">
                                üí° All data will be stored locally - complete privacy!
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderToolsTab() {
            const highRiskServers = state.servers.filter(s => {
                const perms = analyzePermissions(s);
                return perms.some(p => p.level === 'high');
            });

            return `
                <div class="insight-grid">
                    <div class="insight-section">
                        <h3>üîß Bulk Actions</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Perform actions on multiple servers at once
                        </p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn" onclick="exportToCSV()">üìä Export to CSV</button>
                            <button class="btn" onclick="exportToJSON()">üìÑ Export to JSON</button>
                            <button class="btn btn-primary" onclick="exportToPDF()">üìë Export PDF Report</button>
                            <button class="btn btn-primary" onclick="exportComprehensiveData()" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); font-weight: bold;">üíæ Comprehensive Export</button>
                            <button class="btn" onclick="exportRemindersToCalendar()">üìÖ Export Reminders</button>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                üí° <strong>Tip:</strong> Select servers on the Servers tab, then use "üìÅ Categorize" to organize them in bulk!
                            </p>
                        </div>
                    </div>

                    <div class="insight-section">
                        <h3>üîê Permission Auditor</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Servers where you have elevated permissions
                        </p>
                        ${highRiskServers.length > 0 ? `
                            <div class="warning-box">
                                <strong>‚ö†Ô∏è ${highRiskServers.length} server${highRiskServers.length > 1 ? 's' : ''} with Admin access</strong>
                                <p style="margin-top: 0.5rem;">Review these servers to ensure you trust them.</p>
                            </div>
                            ${highRiskServers.slice(0, 5).map(s => {
                                const perms = analyzePermissions(s);
                                return `
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                                        <div style="font-weight: bold;">${s.name}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.25rem;">
                                            ${perms.map(p => `<span class="badge badge-${p.level === 'high' ? 'danger' : 'warning'}">${p.text}</span>`).join(' ')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        ` : `
                            <div class="info-box">
                                <p><strong>‚úÖ No admin permissions</strong></p>
                                <p>You don't have administrator access in any servers (except those you own).</p>
                            </div>
                        `}
                    </div>

                    <div class="insight-section">
                        <h3>üìà Server Growth Tracker</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Track member count changes over time
                        </p>
                        ${state.lastSnapshot ? `
                            <div class="info-box">
                                <p><strong>üì∏ Last snapshot:</strong> ${new Date(state.lastSnapshot).toLocaleDateString()}</p>
                                <p style="margin-top: 0.5rem;">
                                    Tracking ${Object.keys(state.growthHistory).length} servers with ${Object.values(state.growthHistory).reduce((sum, h) => sum + h.length, 0)} total data points.
                                </p>
                            </div>
                            
                            ${(() => {
                                const growingServers = state.servers.filter(s => {
                                    const growth = getServerGrowth(s.id);
                                    return growth && growth.change > 0;
                                }).length;
                                
                                const shrinkingServers = state.servers.filter(s => {
                                    const growth = getServerGrowth(s.id);
                                    return growth && growth.change < 0;
                                }).length;
                                
                                const stableServers = state.servers.filter(s => {
                                    const growth = getServerGrowth(s.id);
                                    return growth && growth.change === 0;
                                }).length;
                                
                                return `
                                    <div style="margin: 1.5rem 0;">
                                        <h4 style="color: var(--accent-secondary); margin-bottom: 1rem;">üìä Growth Overview (Click to view details)</h4>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                            <div onclick="showGrowthDetailsModal('growing')" style="background: rgba(0, 255, 136, 0.1); border: 1px solid var(--accent-primary); border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                <div style="font-size: 2rem; color: var(--accent-primary); font-weight: bold; pointer-events: none;">üìà ${growingServers}</div>
                                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem; pointer-events: none;">Growing</div>
                                            </div>
                                            <div onclick="showGrowthDetailsModal('shrinking')" style="background: rgba(255, 51, 102, 0.1); border: 1px solid var(--accent-danger); border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                <div style="font-size: 2rem; color: var(--accent-danger); font-weight: bold; pointer-events: none;">üìâ ${shrinkingServers}</div>
                                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem; pointer-events: none;">Shrinking</div>
                                            </div>
                                            <div onclick="showGrowthDetailsModal('stable')" style="background: rgba(139, 157, 195, 0.1); border: 1px solid var(--text-secondary); border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                <div style="font-size: 2rem; color: var(--text-secondary); font-weight: bold; pointer-events: none;">‚û°Ô∏è ${stableServers}</div>
                                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem; pointer-events: none;">Stable</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            })()}
                            
                            <h4 style="color: var(--accent-secondary); margin: 1.5rem 0 1rem;">üèÜ Top Movers</h4>
                            ${state.servers.filter(s => getServerGrowth(s.id)).sort((a, b) => {
                                const growthA = getServerGrowth(a.id);
                                const growthB = getServerGrowth(b.id);
                                return Math.abs(growthB.change) - Math.abs(growthA.change);
                            }).slice(0, 5).map(s => {
                                const growth = getServerGrowth(s.id);
                                return `
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: bold;">${s.name}</div>
                                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                                    ${s.memberCount.toLocaleString()} members
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-weight: bold; color: var(--accent-${growth.trending === 'up' ? 'primary' : growth.trending === 'down' ? 'danger' : 'secondary'});">
                                                    ${growth.trending === 'up' ? 'üìà' : growth.trending === 'down' ? 'üìâ' : '‚û°Ô∏è'} ${growth.change > 0 ? '+' : ''}${growth.change.toLocaleString()} (${growth.percentChange}%)
                                                </div>
                                                <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                                    ${growth.dataPoints} snapshots
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        ` : `
                            <div class="info-box">
                                <p><strong>üìä Growth tracking started!</strong></p>
                                <p style="margin-top: 0.5rem;">Come back tomorrow to see member count changes and trending data.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderInsightsTab() {
            const ownedServers = state.servers.filter(s => s.owner);
            const largeServers = state.servers.filter(s => s.memberCount > 5000).sort((a, b) => b.memberCount - a.memberCount);
            const smallServers = state.servers.filter(s => s.memberCount < 50);
            const totalMembers = state.servers.reduce((sum, s) => sum + s.memberCount, 0);
            const avgMembers = Math.round(totalMembers / state.servers.length);
            
            const categoryCounts = {};
            state.servers.forEach(s => {
                categorizeServer(s).forEach(cat => {
                    categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
                });
            });

            return `
                <div class="insight-grid">
                    ${state.connections.length > 0 ? `
                        <div class="insight-section">
                            <h3>üîó Connected Accounts</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Accounts you've linked to Discord
                            </p>
                            ${state.connections.map(conn => `
                                <div class="connection-item">
                                    <div class="connection-icon">${conn.type.charAt(0).toUpperCase()}</div>
                                    <div class="connection-details">
                                        <div class="connection-name">${conn.name}</div>
                                        <div class="connection-type">${conn.type.charAt(0).toUpperCase() + conn.type.slice(1)}${conn.verified ? ' ‚Ä¢ Verified' : ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                            <a href="https://discord.com/settings/connections" target="_blank" class="btn" style="width: 100%; text-decoration: none; text-align: center; margin-top: 1rem;">
                                Manage Connections
                            </a>
                        </div>
                    ` : `
                        <div class="insight-section">
                            <h3>üîó Connected Accounts</h3>
                            <p style="color: var(--text-secondary);">
                                No connected accounts found. Link accounts like Spotify, Xbox, or GitHub!
                            </p>
                            <a href="https://discord.com/settings/connections" target="_blank" class="btn" style="width: 100%; text-decoration: none; text-align: center; margin-top: 1rem;">
                                Connect Accounts
                            </a>
                        </div>
                    `}

                    <div class="insight-section">
                        <h3>üìä Server Distribution</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${state.servers.length}</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${categoryCounts.gaming || 0}</div>
                                <div class="stat-label">Gaming</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${categoryCounts.personal || 0}</div>
                                <div class="stat-label">Personal</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${categoryCounts.work || 0}</div>
                                <div class="stat-label">Work</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${totalMembers.toLocaleString()}</div>
                                <div class="stat-label">Total Members</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${avgMembers.toLocaleString()}</div>
                                <div class="stat-label">Avg/Server</div>
                            </div>
                        </div>
                    </div>

                    ${largeServers.length > 0 ? `
                        <div class="insight-section">
                            <h3>üèÜ Largest Communities</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Your biggest servers by member count
                            </p>
                            ${largeServers.slice(0, 5).map((s, i) => `
                                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                                    <div style="background: var(--accent-primary); color: var(--bg-primary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                        ${i + 1}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 0.25rem;">${s.name}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem;">${s.memberCount.toLocaleString()} members</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${ownedServers.length > 0 ? `
                        <div class="insight-section">
                            <h3>üëë Servers You Own</h3>
                            ${ownedServers.map(s => `
                                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: bold; margin-bottom: 0.25rem;">${s.name}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem;">${s.memberCount.toLocaleString()} members</div>
                                    </div>
                                    <button class="btn" onclick="openDiscordServer('${s.id}')">
                                        Manage
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderGuideTab() {
            return `
                <div class="insight-grid">
                    <div class="insight-section">
                        <h3>üõ°Ô∏è Essential Discord Safety</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Protect yourself from scams, phishing, and security threats
                        </p>
                        
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Never share these with ANYONE:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                <li>Your Discord password</li>
                                <li>2FA/Authentication codes</li>
                                <li>QR codes for "Nitro" or "free items"</li>
                                <li>Your email password</li>
                            </ul>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 1.5rem 0 0.75rem;">üé£ Common Scams to Avoid</h4>
                        
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem;">‚ùå Fake "Free Nitro" Links</div>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                Scammers send fake Discord Nitro offers. <strong>Discord NEVER DMs you</strong> to give free Nitro. 
                                If a link ends in anything other than discord.com or discord.gift, it's fake!
                            </p>
                        </div>

                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem;">‚ùå QR Code Scams</div>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                Never scan a QR code someone sends you, even if it's "for Nitro" or "to verify your account."
                                QR codes can instantly log you into Discord on their device and steal your account!
                            </p>
                        </div>

                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem;">‚ùå Impersonation Scams</div>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                Scammers copy usernames/avatars of friends, staff, or moderators. Always check the actual username 
                                (not just the display name) and server roles before trusting anyone.
                            </p>
                        </div>

                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem;">‚ùå "You've been reported" Scams</div>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                Fake "Discord Trust & Safety" accounts claim you've been reported and need to verify your account.
                                <strong>Real Discord staff will NEVER DM you first!</strong>
                            </p>
                        </div>
                    </div>

                    <div class="insight-section">
                        <h3>üîí Privacy & Security Settings</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Recommended security configurations
                        </p>

                        <h4 style="color: var(--accent-primary); margin-bottom: 0.75rem;">Enable Two-Factor Authentication (2FA)</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                                <strong>Settings ‚Üí My Account ‚Üí Enable Two-Factor Auth</strong>
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                This adds an extra layer of security. Even if someone gets your password, they can't log in without your phone.
                            </p>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 1.5rem 0 0.75rem;">Disable DMs from Server Members</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                                <strong>Right-click any server ‚Üí Privacy Settings ‚Üí Turn off "Direct Messages"</strong>
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                This prevents random people in large servers from DMing you scams. Do this for every server you don't fully trust.
                            </p>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 1.5rem 0 0.75rem;">Review Authorized Apps</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                                <strong>Settings ‚Üí Authorized Apps</strong>
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                Remove any apps you don't recognize or no longer use. Be careful what you authorize!
                            </p>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 1.5rem 0 0.75rem;">Limit Friend Requests</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                                <strong>Settings ‚Üí Privacy & Safety ‚Üí Turn off "Allow friend requests from server members"</strong>
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                Reduces spam friend requests from bots and scammers in large servers.
                            </p>
                        </div>
                    </div>

                    <div class="insight-section">
                        <h3>üí° Advanced Discord Tips</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Power user features you might not know about
                        </p>

                        <h4 style="color: var(--accent-secondary); margin-bottom: 0.75rem;">Server Organization</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>‚Ä¢ Create Server Folders:</strong> Right-click a server ‚Üí "Create Folder" to organize by category
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>‚Ä¢ Mute Servers:</strong> Right-click ‚Üí "Mute Server" ‚Üí Choose duration
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                <strong>‚Ä¢ Hide Muted Servers:</strong> Right-click folder ‚Üí "Hide Muted Servers"
                            </p>
                        </div>

                        <h4 style="color: var(--accent-secondary); margin: 1.5rem 0 0.75rem;">Notification Management</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>‚Ä¢ Suppress @everyone:</strong> Right-click server ‚Üí Notification Settings ‚Üí Suppress @everyone and @here
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>‚Ä¢ Only @mentions:</strong> Set notification to "Only @mentions" for noisy servers
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                <strong>‚Ä¢ Channel-specific:</strong> Mute individual channels while keeping server notifications
                            </p>
                        </div>

                        <h4 style="color: var(--accent-secondary); margin: 1.5rem 0 0.75rem;">Keyboard Shortcuts</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>Ctrl/Cmd + K:</strong> Quick server/channel switcher
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>Ctrl/Cmd + /:</strong> Search for slash commands
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>Alt + Up/Down:</strong> Jump between unread channels
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                <strong>Shift + Esc:</strong> Mark server as read
                            </p>
                        </div>

                        <h4 style="color: var(--accent-secondary); margin: 1.5rem 0 0.75rem;">Data Management</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>‚Ä¢ Request Your Data:</strong> Settings ‚Üí Privacy & Safety ‚Üí "Request all of my Data"
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                <strong>‚Ä¢ Clear Cache:</strong> Settings ‚Üí Advanced ‚Üí "Clear Cache" (fixes weird glitches)
                            </p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                <strong>‚Ä¢ Download Messages:</strong> Use DiscordChatExporter (third-party tool) to backup chats
                            </p>
                        </div>
                    </div>

                    <div class="insight-section">
                        <h3>üö® If You've Been Compromised</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Quick action steps if your account is hacked
                        </p>

                        <div class="warning-box">
                            <strong>Act immediately if you notice:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                <li>Messages you didn't send</li>
                                <li>Servers you didn't join</li>
                                <li>Friends you didn't add</li>
                                <li>Sessions from unknown devices</li>
                            </ul>
                        </div>

                        <div style="margin-top: 1.5rem;">
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid var(--accent-danger);">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">1Ô∏è‚É£ Change Password Immediately</div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Settings ‚Üí My Account ‚Üí Change Password. Use a strong, unique password.
                                </p>
                            </div>

                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid var(--accent-danger);">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">2Ô∏è‚É£ Enable 2FA</div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    If you haven't already, enable Two-Factor Authentication to prevent future attacks.
                                </p>
                            </div>

                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid var(--accent-danger);">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">3Ô∏è‚É£ Log Out All Sessions</div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Settings ‚Üí My Account ‚Üí "Log out of all known devices"
                                </p>
                            </div>

                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid var(--accent-danger);">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">4Ô∏è‚É£ Remove Unauthorized Apps</div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Settings ‚Üí Authorized Apps ‚Üí Remove any apps you don't recognize
                                </p>
                            </div>

                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent-danger);">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">5Ô∏è‚É£ Contact Discord Support</div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Visit support.discord.com to report the compromise and get help recovering your account.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderServerSetupTab() {
            return `
                <div class="insight-grid">
                    <div class="insight-section">
                        <h3>üèóÔ∏è Setting Up Your Discord Server Safely</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Complete guide to creating a secure Discord server using a cold account
                        </p>

                        <div class="warning-box" style="margin-bottom: 2rem;">
                            <strong>‚ö†Ô∏è Critical Security Practice:</strong>
                            <p style="margin-top: 0.5rem;">Always create and manage important Discord servers from a "cold" account - a separate Discord account used ONLY for server ownership, never for regular chatting.</p>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üìã Step 1: Create a Cold Account</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <ol style="margin-left: 1.5rem; line-height: 1.8;">
                                <li><strong>Use a new email:</strong> Create a brand new email address specifically for this Discord account</li>
                                <li><strong>Strong unique password:</strong> Use a password manager to generate a unique 20+ character password</li>
                                <li><strong>Enable 2FA immediately:</strong> Use an authenticator app (Authy, Google Authenticator) - NOT SMS</li>
                                <li><strong>Save backup codes:</strong> Store your 2FA backup codes in a secure location (password manager or physical safe)</li>
                                <li><strong>Never use this account for chatting:</strong> This account should ONLY own servers, never participate in other servers</li>
                            </ol>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üîê Step 2: Secure the Account</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--text-primary); margin-bottom: 1rem;">Enable All Security Features:</h5>
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                <li><strong>Two-Factor Authentication (2FA):</strong> User Settings ‚Üí My Account ‚Üí Enable Two-Factor Auth</li>
                                <li><strong>Require 2FA for moderator actions:</strong> Server Settings ‚Üí Moderation ‚Üí Require 2FA</li>
                                <li><strong>Phone verification:</strong> Add a phone number (can remove after verification if needed)</li>
                                <li><strong>Email verification:</strong> Verify the email address immediately</li>
                            </ul>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üèóÔ∏è Step 3: Create Your Server</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <ol style="margin-left: 1.5rem; line-height: 1.8;">
                                <li><strong>Create server:</strong> Click "+" ‚Üí "Create My Own" ‚Üí Choose template or start from scratch</li>
                                <li><strong>Name carefully:</strong> Choose a clear, professional name (you can change later)</li>
                                <li><strong>Set server icon:</strong> Upload a proper icon immediately to look legitimate</li>
                                <li><strong>Configure verification level:</strong> Server Settings ‚Üí Moderation ‚Üí Verification Level = High</li>
                            </ol>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üë• Step 4: Set Up Your Main Account as Admin</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <ol style="margin-left: 1.5rem; line-height: 1.8;">
                                <li><strong>Create invite link:</strong> Server Settings ‚Üí Invites ‚Üí Create Invite</li>
                                <li><strong>Join with your main account:</strong> Use the invite on your regular Discord account</li>
                                <li><strong>Create Admin role:</strong> Server Settings ‚Üí Roles ‚Üí Create Role ‚Üí Name it "Admin"</li>
                                <li><strong>Grant Administrator permission:</strong> Check "Administrator" box (or specific permissions)</li>
                                <li><strong>Assign to your main account:</strong> Right-click your name ‚Üí Roles ‚Üí Admin</li>
                            </ol>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üõ°Ô∏è Step 5: Configure Server Security</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--text-primary); margin-bottom: 1rem;">Critical Security Settings:</h5>
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                <li><strong>Verification Level ‚Üí High:</strong> Server Settings ‚Üí Moderation ‚Üí Verification Level</li>
                                <li><strong>Explicit content filter ‚Üí Scan all:</strong> Server Settings ‚Üí Moderation ‚Üí Explicit Content Filter</li>
                                <li><strong>Default permissions ‚Üí Minimal:</strong> Server Settings ‚Üí Roles ‚Üí @everyone ‚Üí Remove unnecessary permissions</li>
                                <li><strong>Enable community features:</strong> Server Settings ‚Üí Enable Community (for moderation tools)</li>
                                <li><strong>Set up AutoMod:</strong> Server Settings ‚Üí AutoMod ‚Üí Enable all rules</li>
                                <li><strong>Create mod log channel:</strong> Make a private channel for moderation logs</li>
                            </ul>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">‚ö†Ô∏è Why Use a Cold Account?</h4>
                        <div style="background: rgba(255, 51, 102, 0.1); border: 1px solid var(--accent-danger); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--accent-danger); margin-bottom: 1rem;">Protection from Account Compromise:</h5>
                            <ul style="margin-left: 1.5rem; line-height: 1.8; color: var(--text-primary);">
                                <li><strong>Phishing attacks:</strong> If your main account gets phished, your server is safe</li>
                                <li><strong>Token theft:</strong> Malware stealing your token can't access the server owner account</li>
                                <li><strong>Social engineering:</strong> Someone tricking you can't access server ownership</li>
                                <li><strong>Compromised bot:</strong> A malicious bot can't steal your server</li>
                                <li><strong>Account ban:</strong> If your main account gets banned, you don't lose the server</li>
                            </ul>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">‚úÖ Best Practices Checklist</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                <li>‚òëÔ∏è Cold account with unique email and password</li>
                                <li>‚òëÔ∏è 2FA enabled with backup codes saved</li>
                                <li>‚òëÔ∏è Never use cold account for regular chatting</li>
                                <li>‚òëÔ∏è Main account has Admin role (not Owner)</li>
                                <li>‚òëÔ∏è Verification Level set to High</li>
                                <li>‚òëÔ∏è @everyone role has minimal permissions</li>
                                <li>‚òëÔ∏è AutoMod rules enabled</li>
                                <li>‚òëÔ∏è Mod log channel created</li>
                                <li>‚òëÔ∏è Regular security audits scheduled</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBotGuideTab() {
            return `
                <div class="insight-grid">
                    <div class="insight-section">
                        <h3>ü§ñ Discord Bots: Complete Safety Guide</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            How to add, configure, and secure bots without compromising your server
                        </p>

                        <div class="warning-box" style="margin-bottom: 2rem;">
                            <strong>‚ö†Ô∏è Critical Warning:</strong>
                            <p style="margin-top: 0.5rem;">Bots with Administrator permission can do ANYTHING in your server - delete channels, ban members, change settings, etc. Never give a bot more permissions than it needs!</p>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üîç Step 1: Research the Bot</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--text-primary); margin-bottom: 1rem;">Before Adding ANY Bot:</h5>
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                <li><strong>Check bot age:</strong> Look for bots that have been around 6+ months</li>
                                <li><strong>Read reviews:</strong> Search "[bot name] review" or "[bot name] scam"</li>
                                <li><strong>Check server count:</strong> Bots in 100k+ servers are generally safer</li>
                                <li><strong>Read documentation:</strong> Professional bots have clear docs</li>
                                <li><strong>Check developer:</strong> Look up the developer's reputation</li>
                                <li><strong>Verify official links:</strong> Only add from official bot lists (top.gg, discord.bots.gg) or bot's official website</li>
                            </ul>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">‚ûï Step 2: Adding a Bot Safely</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <ol style="margin-left: 1.5rem; line-height: 1.8;">
                                <li><strong>Click official invite link:</strong> From bot's official site or trusted bot list</li>
                                <li><strong>Review permissions carefully:</strong> Discord shows what permissions the bot requests</li>
                                <li><strong>Uncheck Administrator:</strong> ALWAYS uncheck "Administrator" - grant specific permissions instead</li>
                                <li><strong>Select your server:</strong> Choose which server to add it to</li>
                                <li><strong>Confirm:</strong> Click "Authorize"</li>
                                <li><strong>Complete captcha:</strong> Verify you're human</li>
                            </ol>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üîê Step 3: Configure Permissions Properly</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--text-primary); margin-bottom: 1rem;">Principle of Least Privilege:</h5>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Only give the bot permissions it actually needs to function.</p>
                            
                            <h5 style="color: var(--text-primary); margin: 1.5rem 0 1rem;">Common Bot Types & Safe Permissions:</h5>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <strong style="color: var(--accent-primary);">Moderation Bots (MEE6, Dyno, Carl-bot):</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.6; color: var(--text-secondary);">
                                    <li>‚úÖ Manage Messages</li>
                                    <li>‚úÖ Kick Members</li>
                                    <li>‚úÖ Ban Members</li>
                                    <li>‚úÖ Manage Roles (if needed for auto-roles)</li>
                                    <li>‚ùå Administrator</li>
                                </ul>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <strong style="color: var(--accent-primary);">Music Bots (Groovy, Rythm, Hydra):</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.6; color: var(--text-secondary);">
                                    <li>‚úÖ Connect</li>
                                    <li>‚úÖ Speak</li>
                                    <li>‚úÖ Use Voice Activity</li>
                                    <li>‚ùå Administrator</li>
                                    <li>‚ùå Manage Server</li>
                                </ul>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <strong style="color: var(--accent-primary);">Utility Bots (Tatsumaki, YAGPDB, Pok√©two):</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.6; color: var(--text-secondary);">
                                    <li>‚úÖ Send Messages</li>
                                    <li>‚úÖ Embed Links</li>
                                    <li>‚úÖ Attach Files</li>
                                    <li>‚úÖ Read Message History</li>
                                    <li>‚ùå Administrator</li>
                                </ul>
                            </div>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üö® Red Flags - Dangerous Permissions</h4>
                        <div style="background: rgba(255, 51, 102, 0.1); border: 1px solid var(--accent-danger); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--accent-danger); margin-bottom: 1rem;">NEVER Grant These Unless Absolutely Necessary:</h5>
                            <ul style="margin-left: 1.5rem; line-height: 1.8; color: var(--text-primary);">
                                <li><strong>‚ùå Administrator:</strong> Complete control over everything - NEVER give this</li>
                                <li><strong>‚ö†Ô∏è Manage Server:</strong> Can change server name, icon, region - rarely needed</li>
                                <li><strong>‚ö†Ô∏è Manage Roles:</strong> Can create roles above bot's role - use with caution</li>
                                <li><strong>‚ö†Ô∏è Manage Channels:</strong> Can delete/create channels - only if bot manages channels</li>
                                <li><strong>‚ö†Ô∏è Manage Webhooks:</strong> Can create external integrations - rarely needed</li>
                                <li><strong>‚ö†Ô∏è Mention @everyone:</strong> Can ping everyone - spam risk</li>
                            </ul>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üîß Step 4: Set Up Role Hierarchy</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Roles higher in the list have more power. Proper hierarchy prevents bots from affecting moderators.</p>
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                                <strong style="color: var(--accent-primary);">Correct Role Order (top to bottom):</strong>
                                <ol style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                                    <li>Owner (your role)</li>
                                    <li>Admin</li>
                                    <li>Moderator</li>
                                    <li>Bot Roles (all bot roles here)</li>
                                    <li>Member roles</li>
                                    <li>@everyone</li>
                                </ol>
                            </div>
                            <p style="color: var(--accent-warning); margin-top: 1rem;">üí° This ensures bots can't kick/ban/manage mods or admins!</p>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üõ°Ô∏è Step 5: Configure Bot Settings</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                <li><strong>Limit bot channels:</strong> Use channel permissions to restrict where bot can post</li>
                                <li><strong>Set up bot commands channel:</strong> Create a dedicated #bot-commands channel</li>
                                <li><strong>Configure bot dashboard:</strong> Use bot's web dashboard to set features</li>
                                <li><strong>Set mod-only commands:</strong> Restrict dangerous commands to mod roles only</li>
                                <li><strong>Enable logging:</strong> Make bot log actions to a private mod channel</li>
                            </ul>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">üö® Signs of a Malicious Bot</h4>
                        <div style="background: rgba(255, 51, 102, 0.1); border: 1px solid var(--accent-danger); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h5 style="color: var(--accent-danger); margin-bottom: 1rem;">Remove Immediately If:</h5>
                            <ul style="margin-left: 1.5rem; line-height: 1.8; color: var(--text-primary);">
                                <li>üö´ Bot sends DMs asking for passwords or tokens</li>
                                <li>üö´ Bot creates invite links without permission</li>
                                <li>üö´ Bot deletes channels or bans members unexpectedly</li>
                                <li>üö´ Bot creates @everyone spam</li>
                                <li>üö´ Bot posts NSFW content in non-NSFW channels</li>
                                <li>üö´ Bot creates new roles with admin permissions</li>
                                <li>üö´ Developer asks you to run code or install files</li>
                            </ul>
                        </div>

                        <h4 style="color: var(--accent-primary); margin: 2rem 0 1rem;">‚úÖ Regular Bot Maintenance</h4>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                            <h5 style="color: var(--text-primary); margin-bottom: 1rem;">Monthly Checklist:</h5>
                            <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                <li>‚òëÔ∏è Audit bot permissions - remove any you don't need</li>
                                <li>‚òëÔ∏è Check bot activity - remove inactive bots</li>
                                <li>‚òëÔ∏è Review role hierarchy - ensure bots are below mods</li>
                                <li>‚òëÔ∏è Check for bot updates - read changelog for changes</li>
                                <li>‚òëÔ∏è Test critical bot functions - make sure they work</li>
                                <li>‚òëÔ∏è Remove duplicate bots - don't need 3 music bots</li>
                            </ul>
                        </div>

                        <div class="info-box" style="margin-top: 2rem;">
                            <strong>üí° Pro Tip:</strong>
                            <p style="margin-top: 0.5rem;">Keep a spreadsheet of all bots in your server, what they do, and why you added them. Makes it easy to audit and remove unnecessary bots later!</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRemindersTab() {
            const reminders = Object.entries(state.serverReminders);
            const now = Date.now();
            
            // Sort reminders by date (soonest first)
            reminders.sort((a, b) => new Date(a[1].date) - new Date(b[1].date));
            
            // Split into upcoming and past
            const upcoming = reminders.filter(([_, r]) => new Date(r.date) >= now);
            const past = reminders.filter(([_, r]) => new Date(r.date) < now);
            
            return `
                <div class="insight-grid">
                    <div class="insight-section">
                        <h3>‚è∞ Reminder Dashboard</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Centralized view of all your server reminders with countdown timers
                        </p>

                        ${reminders.length === 0 ? `
                            <div class="info-box">
                                <h4 style="color: var(--accent-primary); margin-bottom: 1rem;">üìù No Reminders Set</h4>
                                <p>You haven't set any reminders yet. Add reminders to servers from the Servers tab!</p>
                                <p style="margin-top: 1rem; color: var(--text-secondary);">Click "üìù Details" on any server ‚Üí Set a reminder date and message.</p>
                            </div>
                        ` : `
                            ${upcoming.length > 0 ? `
                                <div style="margin-bottom: 2rem;">
                                    <h4 style="color: var(--accent-primary); margin-bottom: 1rem;">
                                        üìÖ Upcoming Reminders (${upcoming.length})
                                    </h4>
                                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                                        ${upcoming.map(([serverId, reminder]) => {
                                            const server = state.servers.find(s => s.id === serverId);
                                            if (!server) return '';
                                            
                                            const reminderDate = new Date(reminder.date);
                                            const daysUntil = Math.ceil((reminderDate - now) / (1000 * 60 * 60 * 24));
                                            const hoursUntil = Math.ceil((reminderDate - now) / (1000 * 60 * 60));
                                            
                                            let timeUntil = '';
                                            let urgencyColor = 'var(--accent-primary)';
                                            
                                            if (daysUntil === 0) {
                                                timeUntil = `Today (${hoursUntil}h remaining)`;
                                                urgencyColor = 'var(--accent-danger)';
                                            } else if (daysUntil === 1) {
                                                timeUntil = 'Tomorrow';
                                                urgencyColor = 'var(--accent-warning)';
                                            } else if (daysUntil <= 7) {
                                                timeUntil = `In ${daysUntil} days`;
                                                urgencyColor = 'var(--accent-warning)';
                                            } else {
                                                timeUntil = `In ${daysUntil} days`;
                                            }
                                            
                                            return `
                                                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; border-left: 4px solid ${urgencyColor};">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem; flex-wrap: wrap;">
                                                        <div style="flex: 1; min-width: 200px;">
                                                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                                                <div style="font-weight: bold; font-size: 1.1rem;">${server.name}</div>
                                                                ${state.gameDetections[serverId] ? `<span style="background: rgba(88, 101, 242, 0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">üéÆ ${state.gameDetections[serverId]}</span>` : ''}
                                                            </div>
                                                            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                                                ${server.memberCount.toLocaleString()} members
                                                            </div>
                                                            <div style="background: var(--bg-primary); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem;">
                                                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Reminder:</div>
                                                                <div style="font-style: italic;">"${reminder.note}"</div>
                                                            </div>
                                                        </div>
                                                        <div style="text-align: right; min-width: 150px;">
                                                            <div style="font-size: 1.5rem; font-weight: bold; color: ${urgencyColor}; margin-bottom: 0.5rem;">
                                                                ${timeUntil}
                                                            </div>
                                                            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                                                                ${reminderDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                            </div>
                                                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                                <button class="btn btn-primary" onclick="openDiscordServer('${serverId}')" style="width: 100%;">
                                                                    Open Server
                                                                </button>
                                                                <button class="btn btn-danger" onclick="setServerReminder('${serverId}', null, null); switchTab('reminders');" style="width: 100%;">
                                                                    Remove
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${past.length > 0 ? `
                                <div>
                                    <h4 style="color: var(--text-secondary); margin-bottom: 1rem;">
                                        üìú Past Reminders (${past.length})
                                    </h4>
                                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                                        ${past.map(([serverId, reminder]) => {
                                            const server = state.servers.find(s => s.id === serverId);
                                            if (!server) return '';
                                            
                                            const reminderDate = new Date(reminder.date);
                                            const daysAgo = Math.ceil((now - reminderDate) / (1000 * 60 * 60 * 24));
                                            
                                            return `
                                                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; opacity: 0.7; border-left: 4px solid var(--text-secondary);">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem; flex-wrap: wrap;">
                                                        <div style="flex: 1; min-width: 200px;">
                                                            <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">${server.name}</div>
                                                            <div style="background: var(--bg-primary); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem;">
                                                                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.25rem;">Reminder:</div>
                                                                <div style="font-style: italic; color: var(--text-secondary);">"${reminder.note}"</div>
                                                            </div>
                                                        </div>
                                                        <div style="text-align: right; min-width: 150px;">
                                                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                                                ${daysAgo === 0 ? 'Earlier today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo} days ago`}
                                                            </div>
                                                            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                                                                ${reminderDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                            </div>
                                                            <button class="btn btn-danger" onclick="setServerReminder('${serverId}', null, null); switchTab('reminders');" style="width: 100%;">
                                                                Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        `}

                        <div class="info-box" style="margin-top: 2rem;">
                            <strong>üí° Pro Tip:</strong>
                            <p style="margin-top: 0.5rem;">Reminders are checked every minute. You'll get a browser alert when a reminder is due!</p>
                            <p style="margin-top: 0.5rem;">Export reminders to Google Calendar, Outlook, or Apple Calendar from the Tools tab.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            // Not authenticated
            if (!state.isAuthenticated && !state.loading) {
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div style="margin-bottom: 2rem;">
                                <svg width="120" height="120" viewBox="0 0 120 120" style="margin: 0 auto; display: block; filter: drop-shadow(0 10px 40px rgba(0, 255, 136, 0.3));">
                                    <!-- Background circle with gradient -->
                                    <defs>
                                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#00ff88;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" />
                                        </linearGradient>
                                        <linearGradient id="accentGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#ff3366;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#ffaa00;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    
                                    <!-- Main circle -->
                                    <circle cx="60" cy="60" r="55" fill="url(#logoGradient)" opacity="0.2"/>
                                    <circle cx="60" cy="60" r="55" fill="none" stroke="url(#logoGradient)" stroke-width="3"/>
                                    
                                    <!-- Server/Network nodes -->
                                    <circle cx="60" cy="30" r="8" fill="url(#logoGradient)"/>
                                    <circle cx="35" cy="50" r="8" fill="url(#logoGradient)"/>
                                    <circle cx="85" cy="50" r="8" fill="url(#logoGradient)"/>
                                    <circle cx="45" cy="80" r="8" fill="url(#logoGradient)"/>
                                    <circle cx="75" cy="80" r="8" fill="url(#logoGradient)"/>
                                    
                                    <!-- Center hub (Discord-style) -->
                                    <circle cx="60" cy="60" r="12" fill="#0a0e27"/>
                                    <circle cx="60" cy="60" r="12" fill="none" stroke="url(#accentGradient)" stroke-width="2.5"/>
                                    
                                    <!-- Connection lines -->
                                    <line x1="60" y1="30" x2="60" y2="48" stroke="url(#logoGradient)" stroke-width="2" opacity="0.6"/>
                                    <line x1="35" y1="50" x2="48" y2="56" stroke="url(#logoGradient)" stroke-width="2" opacity="0.6"/>
                                    <line x1="85" y1="50" x2="72" y2="56" stroke="url(#logoGradient)" stroke-width="2" opacity="0.6"/>
                                    <line x1="45" y1="80" x2="54" y2="68" stroke="url(#logoGradient)" stroke-width="2" opacity="0.6"/>
                                    <line x1="75" y1="80" x2="66" y2="68" stroke="url(#logoGradient)" stroke-width="2" opacity="0.6"/>
                                    
                                    <!-- AI/Tech accent - circuit pattern -->
                                    <path d="M 60 55 L 60 48 M 56 60 L 48 60 M 64 60 L 72 60 M 60 65 L 60 72" 
                                          stroke="url(#accentGradient)" 
                                          stroke-width="1.5" 
                                          fill="none" 
                                          opacity="0.8"/>
                                    
                                    <!-- Small pulse circles for tech feel -->
                                    <circle cx="60" cy="60" r="4" fill="url(#accentGradient)">
                                        <animate attributeName="r" values="4;6;4" dur="2s" repeatCount="indefinite"/>
                                        <animate attributeName="opacity" values="1;0.5;1" dur="2s" repeatCount="indefinite"/>
                                    </circle>
                                </svg>
                            </div>
                            <h1>Discord Manager</h1>
                            <p class="subtitle">Complete Discord Server Management Suite</p>
                        </div>
                        
                        ${state.error ? `<div class="error">Error: ${state.error}</div>` : ''}
                        
                        <div class="info-box">
                            <h2 style="color: var(--accent-primary); margin-bottom: 1rem; font-size: 1.5rem;">üéØ What is Discord Manager?</h2>
                            <p style="font-size: 1.1rem; margin-bottom: 1rem;">Discord Manager is a comprehensive, privacy-focused web application that gives you complete control over your Discord servers. Whether you're managing 5 servers or 500, Discord Manager helps you stay organized, secure, and informed.</p>
                            <p style="color: var(--text-secondary);">No installation required - just login with Discord OAuth and start organizing! 100% free, no ads, no tracking.</p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin: 3rem 0;">
                            <div class="insight-section">
                                <h3>üìã Organization Features</h3>
                                <div style="color: var(--text-secondary); line-height: 1.8;">
                                    <p>‚Ä¢ <strong>Smart Categorization:</strong> Auto-categorize servers (Gaming, Work, Social, etc.)</p>
                                    <p>‚Ä¢ <strong>Custom Notes:</strong> Add personal notes to any server</p>
                                    <p>‚Ä¢ <strong>Favorites System:</strong> Star important servers for quick access</p>
                                    <p>‚Ä¢ <strong>Server Reminders:</strong> Set date-based reminders for any server</p>
                                    <p>‚Ä¢ <strong>Last Visited Tracking:</strong> See when you last opened each server</p>
                                    <p>‚Ä¢ <strong>Quick Leave:</strong> Bulk leave multiple servers at once</p>
                                </div>
                            </div>

                            <div class="insight-section">
                                <h3>üìà Analytics & Insights</h3>
                                <div style="color: var(--text-secondary); line-height: 1.8;">
                                    <p>‚Ä¢ <strong>Growth Tracking:</strong> Monitor member count changes over time</p>
                                    <p>‚Ä¢ <strong>Health Dashboard:</strong> See which servers need attention</p>
                                    <p>‚Ä¢ <strong>Server Comparison:</strong> Compare up to 5 servers side-by-side</p>
                                    <p>‚Ä¢ <strong>Role & Permission Analysis:</strong> View all your roles across servers</p>
                                    <p>‚Ä¢ <strong>Game Detection:</strong> Auto-detect gaming servers (23+ games)</p>
                                    <p>‚Ä¢ <strong>LFG Tracker:</strong> Mark servers for finding groups</p>
                                </div>
                            </div>

                            <div class="insight-section">
                                <h3>üîê Security Features</h3>
                                <div style="color: var(--text-secondary); line-height: 1.8;">
                                    <p>‚Ä¢ <strong>Permission Auditor:</strong> Find servers with elevated permissions</p>
                                    <p>‚Ä¢ <strong>Security Scoring:</strong> Health scores based on security factors</p>
                                    <p>‚Ä¢ <strong>Server Setup Guide:</strong> Learn to create servers safely with cold accounts</p>
                                    <p>‚Ä¢ <strong>Bot Safety Guide:</strong> Add bots without compromising security</p>
                                    <p>‚Ä¢ <strong>Risk Detection:</strong> Identify servers with admin access</p>
                                </div>
                            </div>

                            <div class="insight-section">
                                <h3>üé® Customization</h3>
                                <div style="color: var(--text-secondary); line-height: 1.8;">
                                    <p>‚Ä¢ <strong>Dark/Light Themes:</strong> Switch between themes instantly</p>
                                    <p>‚Ä¢ <strong>Saved Presets:</strong> Save your filter/selection workflows</p>
                                    <p>‚Ä¢ <strong>Advanced Filtering:</strong> Filter by category, size, ownership, etc.</p>
                                    <p>‚Ä¢ <strong>Custom Sorting:</strong> Sort by any metric (members, health, growth)</p>
                                    <p>‚Ä¢ <strong>Mobile Optimized:</strong> Works perfectly on phones and tablets</p>
                                </div>
                            </div>

                            <div class="insight-section">
                                <h3>üíæ Export & Backup</h3>
                                <div style="color: var(--text-secondary); line-height: 1.8;">
                                    <p>‚Ä¢ <strong>CSV Export:</strong> Export server list to spreadsheet</p>
                                    <p>‚Ä¢ <strong>JSON Export:</strong> Download structured data</p>
                                    <p>‚Ä¢ <strong>PDF Reports:</strong> Generate professional server reports</p>
                                    <p>‚Ä¢ <strong>Calendar Sync:</strong> Export reminders to Google Calendar, Outlook, etc.</p>
                                    <p>‚Ä¢ <strong>Full Backup:</strong> Export ALL your data (notes, categories, favorites)</p>
                                </div>
                            </div>

                            <div class="insight-section">
                                <h3>üîê Privacy & Security</h3>
                                <div style="color: var(--text-secondary); line-height: 1.8;">
                                    <p>‚Ä¢ <strong>No Data Storage:</strong> We don't store your Discord data on our servers</p>
                                    <p>‚Ä¢ <strong>Local Storage Only:</strong> Everything stays in your browser</p>
                                    <p>‚Ä¢ <strong>OAuth Authentication:</strong> Secure Discord login - we never see your password</p>
                                    <p>‚Ä¢ <strong>Read-Only Access:</strong> We can't modify servers or send messages</p>
                                    <p>‚Ä¢ <strong>No Tracking:</strong> Zero analytics or tracking cookies</p>
                                    <p>‚Ä¢ <strong>Open Source Ready:</strong> Transparent code you can review</p>
                                </div>
                            </div>
                        </div>

                        <div class="info-box" style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(88, 101, 242, 0.1)); border: 1px solid var(--accent-primary); margin-top: 2rem;">
                            <h3 style="color: var(--accent-primary); margin-bottom: 1rem; font-size: 1.3rem;">‚ùì How It Works</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">1Ô∏è‚É£</div>
                                    <strong>Login</strong>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Click "Login with Discord" - uses official OAuth</p>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">2Ô∏è‚É£</div>
                                    <strong>Authorize</strong>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Grant read-only permission to view your servers</p>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">3Ô∏è‚É£</div>
                                    <strong>Organize</strong>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Categorize, filter, and manage all your servers</p>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">4Ô∏è‚É£</div>
                                    <strong>Track & Export</strong>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Monitor growth, export data, stay organized</p>
                                </div>
                            </div>
                        </div>

                        <div class="info-box" style="margin-top: 2rem;">
                            <h3 style="color: var(--accent-primary); margin-bottom: 1rem;">‚ö†Ô∏è Important: This is NOT a Phishing Site</h3>
                            <p><strong>Discord Manager uses official Discord OAuth for authentication.</strong> We never ask for your password and cannot access your account credentials. You can verify the OAuth redirect goes to discord.com (not a fake site).</p>
                            <p style="margin-top: 1rem; color: var(--text-secondary);">If your antivirus flagged this site, it's a false positive because we're a new domain. You can safely whitelist discordmanage.com or <a href="https://www.avg.com/en-us/false-positive-file-form" target="_blank" style="color: var(--accent-secondary);">report the false positive to your antivirus</a>.</p>
                        </div>

                        <div class="login-section">
                            <button class="login-btn" onclick="handleDiscordLogin()">Login with Discord</button>
                            <p style="color: var(--text-secondary); margin-top: 1rem; font-size: 0.9rem;">
                                By logging in, you agree to our <a href="#" onclick="showPrivacyPolicy(); return false;" style="color: var(--accent-primary);">Privacy Policy</a> and <a href="#" onclick="showTerms(); return false;" style="color: var(--accent-primary);">Terms of Service</a>
                            </p>
                        </div>

                        <div style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Created by <a href="https://x.com/ObiWanBENobiETH" target="_blank" style="color: var(--accent-primary);">@ObiWanBENobiETH</a></p>
                            <p style="color: var(--text-secondary); font-size: 0.85rem;">
                                Questions or issues? Contact me on <a href="https://x.com/ObiWanBENobiETH" target="_blank" style="color: var(--accent-secondary);">Twitter/X</a>
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            // Loading
            if (state.loading) {
                app.innerHTML = `
                    <div class="container">
                        <div class="header"><h1>Discord Manager</h1></div>
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading your data...</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Authenticated
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>Discord Manager</h1>
                        <p class="subtitle">Complete Server Management Suite</p>
                    </div>

                    ${state.error ? `
                        <div class="error">
                            <strong>Error:</strong> ${state.error}
                            <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                                This could be due to:
                                ‚Ä¢ Discord API being temporarily unavailable
                                ‚Ä¢ Your token expiring (try logging out and back in)
                                ‚Ä¢ Network connectivity issues
                            </p>
                            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 1rem;">
                                üîÑ Retry
                            </button>
                            <button class="btn" onclick="handleLogout()" style="margin-top: 1rem;">
                                üö™ Logout & Re-login
                            </button>
                        </div>
                    ` : ''}

                    ${state.user ? `
                        <div class="user-info">
                            <img class="user-avatar" src="https://cdn.discordapp.com/avatars/${state.user.id}/${state.user.avatar}.png?size=128" alt="Avatar" onerror="this.style.display='none'">
                            <div class="user-details">
                                <div class="user-name">${state.user.username}${state.user.discriminator !== '0' ? '#' + state.user.discriminator : ''}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Connected to Discord</div>
                            </div>
                            <button class="btn" onclick="showSettingsModal()" style="margin-right: 0.5rem;">‚öôÔ∏è Settings</button>
                            <button class="btn" onclick="handleLogout()">Logout</button>
                        </div>

                        <div class="tabs">
                            <button class="tab ${state.currentTab === 'servers' ? 'active' : ''}" onclick="switchTab('servers')">
                                üìã Servers (${state.servers.length})
                            </button>
                            <button class="tab ${state.currentTab === 'analytics' ? 'active' : ''}" onclick="switchTab('analytics')">
                                üî¨ Analytics
                            </button>
                            <button class="tab ${state.currentTab === 'tools' ? 'active' : ''}" onclick="switchTab('tools')">
                                üîß Tools
                            </button>
                            <button class="tab ${state.currentTab === 'insights' ? 'active' : ''}" onclick="switchTab('insights')">
                                üìä Insights
                            </button>
                            <button class="tab ${state.currentTab === 'guide' ? 'active' : ''}" onclick="switchTab('guide')">
                                üõ°Ô∏è Safety Guide
                            </button>
                            <button class="tab ${state.currentTab === 'serversetup' ? 'active' : ''}" onclick="switchTab('serversetup')">
                                üèóÔ∏è Server Setup
                            </button>
                            <button class="tab ${state.currentTab === 'bots' ? 'active' : ''}" onclick="switchTab('bots')">
                                ü§ñ Bot Guide
                            </button>
                            <button class="tab ${state.currentTab === 'reminders' ? 'active' : ''}" onclick="switchTab('reminders')">
                                ‚è∞ Reminders ${(() => {
                                    const upcoming = Object.entries(state.serverReminders).filter(([_, r]) => new Date(r.date) >= Date.now());
                                    return upcoming.length > 0 ? `<span style="background: var(--accent-danger); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.85rem; margin-left: 0.5rem;">${upcoming.length}</span>` : '';
                                })()}
                            </button>
                        </div>
                    ` : ''}

                    ${state.currentTab === 'servers' ? renderServersTab() : ''}
                    ${state.currentTab === 'analytics' ? renderAnalyticsTab() : ''}
                    ${state.currentTab === 'tools' ? renderToolsTab() : ''}
                    ${state.currentTab === 'insights' ? renderInsightsTab() : ''}
                    ${state.currentTab === 'guide' ? renderGuideTab() : ''}
                    ${state.currentTab === 'serversetup' ? renderServerSetupTab() : ''}
                    ${state.currentTab === 'bots' ? renderBotGuideTab() : ''}
                    ${state.currentTab === 'reminders' ? renderRemindersTab() : ''}
                </div>
            `;
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
