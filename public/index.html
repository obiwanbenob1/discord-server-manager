<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Manager - Complete Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Archivo+Black&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151937;
            --bg-card: #1a1f3a;
            --accent-primary: #00ff88;
            --accent-secondary: #00d4ff;
            --accent-danger: #ff3366;
            --accent-warning: #ffaa00;
            --text-primary: #e8f4f8;
            --text-secondary: #8b9dc3;
            --border: #2a3354;
            --shadow: rgba(0, 255, 136, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            padding: 4rem 0 3rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
            opacity: 0.1;
            filter: blur(60px);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.15; transform: translateX(-50%) scale(1.1); }
        }

        h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 3.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .login-section {
            text-align: center;
            padding: 4rem 2rem;
            animation: fadeIn 1s ease-out 0.4s both;
        }

        .login-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            border: none;
            padding: 1.2rem 3rem;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Space Mono', monospace;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s ease;
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px var(--shadow);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: var(--accent-primary);
        }

        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
            animation: fadeIn 0.8s ease-out;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px var(--shadow);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-primary);
            font-family: 'Archivo Black', sans-serif;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.5rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--shadow);
        }

        .btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        .btn-danger {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #ff1a4d;
            border-color: #ff1a4d;
            box-shadow: 0 4px 20px rgba(255, 51, 102, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .item-list {
            display: grid;
            gap: 1rem;
        }

        .item-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            animation: slideUp 0.4s ease-out both;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .item-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .item-card.selected {
            border-color: var(--accent-secondary);
            background: rgba(0, 212, 255, 0.05);
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .item-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            flex-shrink: 0;
            border: 2px solid var(--border);
            overflow: hidden;
        }

        .item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .item-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: 0.5rem;
        }

        .badge-primary {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-primary);
        }

        .badge-secondary {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-secondary);
        }

        .badge-danger {
            background: rgba(255, 51, 102, 0.2);
            color: var(--accent-danger);
        }

        .badge-warning {
            background: rgba(255, 170, 0, 0.2);
            color: var(--accent-warning);
        }

        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .info-box {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-box p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            color: var(--accent-primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal {
            background: var(--bg-card);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 255, 136, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .modal h2 {
            color: var(--accent-primary);
            margin-bottom: 1rem;
            font-family: 'Archivo Black', sans-serif;
        }

        .modal-steps {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .modal-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .modal-step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            background: var(--accent-primary);
            color: var(--bg-primary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-text {
            flex: 1;
            padding-top: 0.2rem;
        }

        .modal-close {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
        }

        .server-opened {
            color: var(--accent-secondary);
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .insight-grid {
            display: grid;
            gap: 2rem;
        }

        .insight-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
        }

        .insight-section h3 {
            color: var(--accent-primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .connection-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .connection-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--bg-primary);
        }

        .connection-details {
            flex: 1;
        }

        .connection-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .connection-type {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .category-filter {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .category-chip {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-chip:hover {
            border-color: var(--accent-primary);
        }

        .category-chip.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .warning-box {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid var(--accent-warning);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .warning-box strong {
            color: var(--accent-warning);
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ===== GLOBAL STATE =====
        let state = {
            isAuthenticated: false,
            loading: false,
            error: null,
            currentTab: 'servers',
            
            // User data
            user: null,
            accessToken: null,
            
            // Servers
            servers: [],
            selectedServers: new Set(),
            
            // Connections
            connections: [],
            
            // UI state
            searchTerm: '',
            sortBy: 'name',
            categoryFilter: 'all', // all, gaming, personal, work, large, owned, uncategorized
            
            // Manual categorization (stored in localStorage)
            serverCategories: {}, // { serverId: ['gaming', 'personal'] }
            
            // Growth tracking (stored in localStorage)
            growthHistory: {}, // { serverId: [{ date, memberCount }] }
            lastSnapshot: null,
            
            // Multi-account (future feature)
            accounts: []
        };

        // Available categories
        const CATEGORIES = {
            gaming: { emoji: 'üéÆ', label: 'Gaming' },
            work: { emoji: 'üíº', label: 'Work' },
            personal: { emoji: 'üë•', label: 'Personal' },
            education: { emoji: 'üìö', label: 'Education' },
            creative: { emoji: 'üé®', label: 'Creative' },
            tech: { emoji: 'üíª', label: 'Tech' },
            hobby: { emoji: 'üéØ', label: 'Hobby' },
            community: { emoji: 'üåê', label: 'Community' }
        };

        // ===== INITIALIZATION =====
        function init() {
            loadGrowthHistory();
            loadServerCategories();
            handleOAuthCallback();
            render();
            
            // Take snapshot on login
            if (state.isAuthenticated) {
                takeServerSnapshot();
            }
        }

        // ===== OAUTH & AUTH =====
        function handleOAuthCallback() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const error = params.get('error');
            
            if (error) {
                state.error = 'Authentication failed. Please try again.';
                window.history.replaceState({}, document.title, window.location.pathname);
                render();
                return;
            }
            
            if (token) {
                state.accessToken = token;
                try {
                    localStorage.setItem('discord_token', token);
                } catch (e) {
                    sessionStorage.setItem('discord_token', token);
                }
                window.history.replaceState({}, document.title, window.location.pathname);
                loadDiscordData(token);
            } else {
                let savedToken = null;
                try {
                    savedToken = localStorage.getItem('discord_token');
                } catch (e) {
                    savedToken = sessionStorage.getItem('discord_token');
                }
                if (savedToken) {
                    state.accessToken = savedToken;
                    loadDiscordData(savedToken);
                }
            }
        }

        async function handleDiscordLogin() {
            try {
                const response = await fetch('/api/auth/url');
                const data = await response.json();
                window.location.href = data.url;
            } catch (error) {
                state.error = 'Failed to initiate login. Please try again.';
                render();
            }
        }

        async function loadDiscordData(token) {
            state.loading = true;
            state.error = null;
            render();

            try {
                // Fetch user info
                const userResponse = await fetch('/api/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!userResponse.ok) throw new Error('Failed to fetch user data');
                state.user = await userResponse.json();

                // Fetch guilds
                const guildsResponse = await fetch('/api/guilds', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!guildsResponse.ok) throw new Error('Failed to fetch servers');
                state.servers = await guildsResponse.json();

                // Fetch connections
                try {
                    const connectionsResponse = await fetch('/api/connections', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (connectionsResponse.ok) {
                        state.connections = await connectionsResponse.json();
                    }
                } catch (e) {
                    console.warn('Failed to fetch connections:', e);
                }

                state.isAuthenticated = true;
                state.loading = false;
                
                // Take growth snapshot
                takeServerSnapshot();
                
                render();
            } catch (error) {
                state.error = error.message;
                state.loading = false;
                localStorage.removeItem('discord_token');
                sessionStorage.removeItem('discord_token');
                render();
            }
        }

        function handleLogout() {
            localStorage.removeItem('discord_token');
            sessionStorage.removeItem('discord_token');
            state = {
                isAuthenticated: false,
                loading: false,
                error: null,
                currentTab: 'servers',
                user: null,
                accessToken: null,
                servers: [],
                selectedServers: new Set(),
                connections: [],
                searchTerm: '',
                sortBy: 'name',
                categoryFilter: 'all',
                growthHistory: state.growthHistory, // Keep growth history
                lastSnapshot: state.lastSnapshot,
                accounts: []
            };
            render();
        }

        // ===== GROWTH TRACKING =====
        function loadGrowthHistory() {
            try {
                const saved = localStorage.getItem('discord_growth_history');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.growthHistory = data.history || {};
                    state.lastSnapshot = data.lastSnapshot || null;
                }
            } catch (e) {
                console.warn('Failed to load growth history:', e);
            }
        }

        function saveGrowthHistory() {
            try {
                localStorage.setItem('discord_growth_history', JSON.stringify({
                    history: state.growthHistory,
                    lastSnapshot: state.lastSnapshot
                }));
            } catch (e) {
                console.warn('Failed to save growth history:', e);
            }
        }

        function takeServerSnapshot() {
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            
            // Only take snapshot once per day
            if (state.lastSnapshot && state.lastSnapshot > oneDayAgo) {
                return;
            }
            
            state.servers.forEach(server => {
                if (!state.growthHistory[server.id]) {
                    state.growthHistory[server.id] = [];
                }
                
                state.growthHistory[server.id].push({
                    date: now,
                    memberCount: server.memberCount
                });
                
                // Keep only last 90 days
                const ninetyDaysAgo = now - (90 * 24 * 60 * 60 * 1000);
                state.growthHistory[server.id] = state.growthHistory[server.id].filter(
                    snapshot => snapshot.date > ninetyDaysAgo
                );
            });
            
            state.lastSnapshot = now;
            saveGrowthHistory();
        }

        function getServerGrowth(serverId) {
            const history = state.growthHistory[serverId] || [];
            if (history.length < 2) return null;
            
            const latest = history[history.length - 1];
            const oldest = history[0];
            const change = latest.memberCount - oldest.memberCount;
            const percentChange = ((change / oldest.memberCount) * 100).toFixed(1);
            
            return {
                change,
                percentChange,
                trending: change > 0 ? 'up' : change < 0 ? 'down' : 'stable',
                dataPoints: history.length
            };
        }

        // ===== MANUAL CATEGORIZATION =====
        function loadServerCategories() {
            try {
                const saved = localStorage.getItem('discord_server_categories');
                if (saved) {
                    state.serverCategories = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Failed to load server categories:', e);
            }
        }

        function saveServerCategories() {
            try {
                localStorage.setItem('discord_server_categories', JSON.stringify(state.serverCategories));
            } catch (e) {
                console.warn('Failed to save server categories:', e);
            }
        }

        function toggleServerCategory(serverId, category) {
            if (!state.serverCategories[serverId]) {
                state.serverCategories[serverId] = [];
            }
            
            const categories = state.serverCategories[serverId];
            const index = categories.indexOf(category);
            
            if (index > -1) {
                categories.splice(index, 1);
            } else {
                categories.push(category);
            }
            
            saveServerCategories();
            render();
        }

        function setServerCategories(serverId, categories) {
            state.serverCategories[serverId] = categories;
            saveServerCategories();
            render();
        }

        function bulkCategorize(category) {
            const selected = Array.from(state.selectedServers);
            selected.forEach(serverId => {
                if (!state.serverCategories[serverId]) {
                    state.serverCategories[serverId] = [];
                }
                if (!state.serverCategories[serverId].includes(category)) {
                    state.serverCategories[serverId].push(category);
                }
            });
            saveServerCategories();
            render();
        }

        // ===== SERVER CATEGORIZATION =====
        function categorizeServer(server) {
            // Use manual categories if set
            if (state.serverCategories[server.id] && state.serverCategories[server.id].length > 0) {
                return state.serverCategories[server.id];
            }
            
            // Otherwise show as uncategorized
            const autoCategories = [];
            
            // Only auto-detect size-based and ownership
            if (server.owner) autoCategories.push('owned');
            if (server.memberCount > 5000) autoCategories.push('large');
            
            return autoCategories.length > 0 ? autoCategories : ['uncategorized'];
        }

        function getSuggestedCategories(server) {
            // Provide smart suggestions based on keywords
            const suggestions = [];
            const nameLower = server.name.toLowerCase();
            
            // Gaming suggestions
            if (nameLower.match(/game|gaming|gamer|play|clan|guild|fps|mmo|rpg|valorant|apex|fortnite|cod|minecraft|league|overwatch|csgo|destiny|wow|pokemon|twitch|esport/)) {
                suggestions.push('gaming');
            }
            
            // Work suggestions
            if (nameLower.match(/work|team|company|corp|business|office|professional|studio|agency/)) {
                suggestions.push('work');
            }
            
            // Personal/Friend suggestions (small servers)
            if (server.memberCount < 50) {
                suggestions.push('personal');
            }
            
            // Education suggestions
            if (nameLower.match(/study|learn|school|university|college|education|class|course/)) {
                suggestions.push('education');
            }
            
            // Creative suggestions
            if (nameLower.match(/art|creative|design|music|draw|artist|portfolio/)) {
                suggestions.push('creative');
            }
            
            // Tech suggestions
            if (nameLower.match(/dev|code|programming|tech|software|engineer|linux|python|javascript|react/)) {
                suggestions.push('tech');
            }
            
            // Community suggestions
            if (server.memberCount > 1000 && !nameLower.match(/game|gaming/)) {
                suggestions.push('community');
            }
            
            return suggestions;
        }

        // ===== DUPLICATE DETECTION =====
        function findDuplicateServers() {
            const duplicates = [];
            const seen = new Map();
            
            state.servers.forEach(server => {
                const nameLower = server.name.toLowerCase().trim();
                
                if (seen.has(nameLower)) {
                    duplicates.push({
                        server1: seen.get(nameLower),
                        server2: server
                    });
                } else {
                    seen.set(nameLower, server);
                }
            });
            
            return duplicates;
        }

        // ===== PERMISSION ANALYSIS =====
        function analyzePermissions(server) {
            const perms = parseInt(server.permissions);
            const risks = [];
            
            // Check for admin permission (0x8)
            if ((perms & 0x8) === 0x8) {
                risks.push({ level: 'high', text: 'Administrator' });
            }
            
            // Check for manage server (0x20)
            if ((perms & 0x20) === 0x20) {
                risks.push({ level: 'medium', text: 'Manage Server' });
            }
            
            // Check for manage roles (0x10000000)
            if ((perms & 0x10000000) === 0x10000000) {
                risks.push({ level: 'medium', text: 'Manage Roles' });
            }
            
            // Check for manage channels (0x10)
            if ((perms & 0x10) === 0x10) {
                risks.push({ level: 'low', text: 'Manage Channels' });
            }
            
            return risks;
        }

        // ===== EXPORT FUNCTIONALITY =====
        function exportToCSV() {
            const headers = ['Server Name', 'Members', 'Owner', 'Categories', 'Member Growth'];
            const rows = state.servers.map(server => {
                const categories = categorizeServer(server).join('; ');
                const growth = getServerGrowth(server.id);
                const growthStr = growth ? `${growth.change} (${growth.percentChange}%)` : 'No data';
                
                return [
                    server.name,
                    server.memberCount,
                    server.owner ? 'Yes' : 'No',
                    categories,
                    growthStr
                ];
            });
            
            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `discord-servers-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToJSON() {
            const data = {
                exportDate: new Date().toISOString(),
                user: state.user.username,
                servers: state.servers.map(server => ({
                    name: server.name,
                    id: server.id,
                    memberCount: server.memberCount,
                    owner: server.owner,
                    categories: categorizeServer(server),
                    growth: getServerGrowth(server.id)
                })),
                connections: state.connections,
                totalServers: state.servers.length
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `discord-data-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===== UTILITY FUNCTIONS =====
        function formatDate(date) {
            const now = Date.now();
            const diff = now - new Date(date);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor(diff / (1000 * 60));

            if (days > 30) return `${days} days ago`;
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        function switchTab(tab) {
            state.currentTab = tab;
            state.searchTerm = '';
            render();
        }

        function updateSearch(value) {
            state.searchTerm = value;
            render();
        }

        function updateSort(value) {
            state.sortBy = value;
            render();
        }

        function updateCategoryFilter(category) {
            state.categoryFilter = category;
            render();
        }

        function showPrivacyPolicy() {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
                        <h2>Privacy Policy</h2>
                        <div style="color: var(--text-secondary); max-height: 60vh; overflow-y: auto;">
                            <p style="margin-bottom: 1rem;"><strong>Last Updated:</strong> January 25, 2026</p>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">What We Collect</h3>
                            <p>Discord Manager uses Discord OAuth to access:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Your Discord username and ID</li>
                                <li>List of Discord servers you're in (names, member counts, icons)</li>
                                <li>Your connected accounts (if granted permission)</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">What We DON'T Collect</h3>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Your Discord password (we never see it)</li>
                                <li>Your messages or DMs</li>
                                <li>Any personal information beyond what Discord OAuth provides</li>
                                <li>Analytics or tracking data</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">How We Store Data</h3>
                            <p><strong>On Our Servers:</strong> We DO NOT store any of your Discord data on our servers. All data is fetched in real-time from Discord's API when you login.</p>
                            <p><strong>In Your Browser:</strong> The following is stored locally in your browser using localStorage:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Your server categories (custom tags you create)</li>
                                <li>Server growth snapshots (member count history)</li>
                                <li>Your login token (to keep you logged in)</li>
                            </ul>
                            <p>This data never leaves your computer and can be cleared by logging out or clearing your browser data.</p>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Third-Party Services</h3>
                            <p>We use:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li><strong>Discord OAuth:</strong> For authentication (governed by Discord's privacy policy)</li>
                                <li><strong>Render.com:</strong> For hosting (no user data stored)</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Your Rights</h3>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>You can revoke access anytime in Discord Settings ‚Üí Authorized Apps</li>
                                <li>You can clear all local data by logging out</li>
                                <li>You can export your data using our CSV/JSON export features</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Contact</h3>
                            <p>Questions about privacy? Contact <a href="https://x.com/ObiWanBENobiETH" target="_blank" style="color: var(--accent-secondary);">@ObiWanBENobiETH on Twitter/X</a></p>
                        </div>
                        <button class="modal-close" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function showTerms() {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px;">
                        <h2>Terms of Service</h2>
                        <div style="color: var(--text-secondary); max-height: 60vh; overflow-y: auto;">
                            <p style="margin-bottom: 1rem;"><strong>Last Updated:</strong> January 25, 2026</p>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Acceptance of Terms</h3>
                            <p>By using Discord Manager, you agree to these terms. If you don't agree, please don't use the service.</p>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Description of Service</h3>
                            <p>Discord Manager is a free tool that helps you organize and manage your Discord servers. It provides:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Server categorization and organization</li>
                                <li>Growth tracking and analytics</li>
                                <li>Bulk management tools</li>
                                <li>Data export capabilities</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">User Responsibilities</h3>
                            <p>You agree to:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Use the service in compliance with Discord's Terms of Service</li>
                                <li>Not use the service for any illegal purposes</li>
                                <li>Not attempt to hack, exploit, or abuse the service</li>
                                <li>Not use automated tools to access the service excessively</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Disclaimer</h3>
                            <p><strong>Discord Manager is provided "as is" without warranties of any kind.</strong></p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>We are not affiliated with Discord Inc.</li>
                                <li>We don't guarantee 100% uptime or availability</li>
                                <li>Server growth data is approximate and based on available information</li>
                                <li>Activity data is simulated for demonstration purposes</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Limitation of Liability</h3>
                            <p>We are not responsible for:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Loss of data stored in your browser</li>
                                <li>Any actions you take based on the information provided</li>
                                <li>Issues arising from Discord API changes</li>
                                <li>Any damages resulting from use of the service</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Changes to Service</h3>
                            <p>We reserve the right to:</p>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                                <li>Modify or discontinue the service at any time</li>
                                <li>Update these terms with notice</li>
                                <li>Change features or functionality</li>
                            </ul>
                            
                            <h3 style="color: var(--accent-primary); margin-top: 1.5rem; margin-bottom: 0.5rem;">Contact</h3>
                            <p>Questions about these terms? Contact <a href="https://x.com/ObiWanBENobiETH" target="_blank" style="color: var(--accent-secondary);">@ObiWanBENobiETH on Twitter/X</a></p>
                        </div>
                        <button class="modal-close" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function showCategoryModal(serverId, serverName) {
            const server = state.servers.find(s => s.id === serverId);
            const currentCategories = state.serverCategories[serverId] || [];
            const suggestions = getSuggestedCategories(server);
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h2>üìÅ Categorize Server</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            <strong>${serverName}</strong>
                        </p>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--accent-primary);">Select Categories:</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                ${Object.entries(CATEGORIES).map(([key, cat]) => {
                                    const isSelected = currentCategories.includes(key);
                                    const isSuggested = suggestions.includes(key);
                                    return `
                                        <button 
                                            class="btn ${isSelected ? 'btn-primary' : ''}" 
                                            onclick="toggleServerCategory('${serverId}', '${key}')"
                                            style="text-align: left; position: relative;">
                                            ${cat.emoji} ${cat.label}
                                            ${isSuggested && !isSelected ? '<span style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--accent-secondary);">suggested</span>' : ''}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        ${suggestions.length > 0 ? `
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    üí° <strong>Suggestions based on server name/size:</strong><br>
                                    ${suggestions.map(s => CATEGORIES[s].emoji + ' ' + CATEGORIES[s].label).join(', ')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <button class="modal-close" onclick="closeModal()">Done</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function showBulkCategoryModal() {
            if (state.selectedServers.size === 0) {
                alert('Please select servers first!');
                return;
            }
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h2>üìÅ Bulk Categorize</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Add category to ${state.selectedServers.size} selected server${state.selectedServers.size > 1 ? 's' : ''}
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            ${Object.entries(CATEGORIES).map(([key, cat]) => `
                                <button 
                                    class="btn btn-primary" 
                                    onclick="bulkCategorize('${key}'); closeModal();"
                                    style="text-align: left;">
                                    ${cat.emoji} ${cat.label}
                                </button>
                            `).join('')}
                        </div>
                        
                        <button class="modal-close" onclick="closeModal()" style="margin-top: 1rem;">Cancel</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function closeModal() {
            const modal = document.getElementById('instruction-modal');
            if (modal) modal.remove();
        }

        // ===== SERVER FUNCTIONS =====
        function getFilteredServers() {
            let filtered = state.servers.filter(s => 
                s.name.toLowerCase().includes(state.searchTerm.toLowerCase())
            );
            
            // Category filter
            if (state.categoryFilter !== 'all') {
                filtered = filtered.filter(s => 
                    categorizeServer(s).includes(state.categoryFilter)
                );
            }
            
            // Sort
            return filtered.sort((a, b) => {
                if (state.sortBy === 'members') return b.memberCount - a.memberCount;
                if (state.sortBy === 'name') return a.name.localeCompare(b.name);
                if (state.sortBy === 'growth') {
                    const growthA = getServerGrowth(a.id);
                    const growthB = getServerGrowth(b.id);
                    if (!growthA && !growthB) return 0;
                    if (!growthA) return 1;
                    if (!growthB) return -1;
                    return growthB.change - growthA.change;
                }
                return 0;
            });
        }

        function getServerStats() {
            return {
                total: state.servers.length,
                owned: state.servers.filter(s => s.owner).length,
                selected: state.selectedServers.size,
                large: state.servers.filter(s => s.memberCount > 5000).length,
                small: state.servers.filter(s => s.memberCount < 100).length
            };
        }

        function toggleServer(serverId) {
            if (state.selectedServers.has(serverId)) {
                state.selectedServers.delete(serverId);
            } else {
                state.selectedServers.add(serverId);
            }
            render();
        }

        function selectByCategory(category) {
            const servers = state.servers.filter(s => 
                categorizeServer(s).includes(category)
            );
            state.selectedServers = new Set(servers.map(s => s.id));
            render();
        }

        function selectSmallServers() {
            const small = state.servers.filter(s => s.memberCount < 100);
            state.selectedServers = new Set(small.map(s => s.id));
            render();
        }

        function selectAll() {
            state.selectedServers = new Set(state.servers.map(s => s.id));
            render();
        }

        function deselectAll() {
            state.selectedServers = new Set();
            render();
        }

        function openSelectedServers() {
            if (state.selectedServers.size === 0) return;
            
            const selectedArray = Array.from(state.selectedServers);
            
            if (selectedArray.length > 10) {
                if (!confirm(`This will open ${selectedArray.length} Discord tabs. Are you sure?`)) {
                    return;
                }
            }
            
            selectedArray.forEach(serverId => {
                window.open(`https://discord.com/channels/${serverId}`, '_blank');
            });
            
            showLeaveServerInstructions(selectedArray.length);
        }

        function openServerWithInstructions(serverId, serverName) {
            window.open(`https://discord.com/channels/${serverId}`, '_blank');
            showLeaveServerInstructions(1, serverName);
        }

        function showLeaveServerInstructions(count, serverName) {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h2>üìç Discord Opened!</h2>
                        ${serverName ? `<p class="server-opened">Server: ${serverName}</p>` : `<p class="server-opened">${count} server(s) opened in new tab(s)</p>`}
                        <div class="modal-steps">
                            <div class="modal-step">
                                <div class="step-number">1</div>
                                <div class="step-text">Find the server icon in the left sidebar of Discord</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">2</div>
                                <div class="step-text">Right-click the server icon</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">3</div>
                                <div class="step-text">Click "Leave Server" in the menu</div>
                            </div>
                            <div class="modal-step">
                                <div class="step-number">4</div>
                                <div class="step-text">Confirm by clicking "Leave Server" again</div>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()">Got it!</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function showDuplicateModal() {
            const duplicates = findDuplicateServers();
            
            if (duplicates.length === 0) {
                alert('No duplicate servers found!');
                return;
            }
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h2>üîç Duplicate Servers Found</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Found ${duplicates.length} potential duplicate${duplicates.length > 1 ? 's' : ''}. You might be in these servers multiple times.
                        </p>
                        ${duplicates.map(dup => `
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">${dup.server1.name}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Server 1: ${dup.server1.memberCount.toLocaleString()} members
                                    <br>
                                    Server 2: ${dup.server2.memberCount.toLocaleString()} members
                                </div>
                            </div>
                        `).join('')}
                        <button class="modal-close" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.id = 'instruction-modal';
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        // ===== RENDER FUNCTIONS =====
        function renderServersTab() {
            const stats = getServerStats();
            const filtered = getFilteredServers();

            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total Servers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.owned}</div>
                        <div class="stat-label">You Own</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.large}</div>
                        <div class="stat-label">Large (5000+)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.small}</div>
                        <div class="stat-label">Small (<100)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.selected}</div>
                        <div class="stat-label">Selected</div>
                    </div>
                </div>

                <div class="category-filter">
                    <div class="category-chip ${state.categoryFilter === 'all' ? 'active' : ''}" onclick="updateCategoryFilter('all')">
                        All Servers
                    </div>
                    <div class="category-chip ${state.categoryFilter === 'uncategorized' ? 'active' : ''}" onclick="updateCategoryFilter('uncategorized')">
                        ‚ùì Uncategorized
                    </div>
                    ${Object.entries(CATEGORIES).map(([key, cat]) => `
                        <div class="category-chip ${state.categoryFilter === key ? 'active' : ''}" onclick="updateCategoryFilter('${key}')">
                            ${cat.emoji} ${cat.label}
                        </div>
                    `).join('')}
                    <div class="category-chip ${state.categoryFilter === 'large' ? 'active' : ''}" onclick="updateCategoryFilter('large')">
                        üèÜ Large (5000+)
                    </div>
                    <div class="category-chip ${state.categoryFilter === 'owned' ? 'active' : ''}" onclick="updateCategoryFilter('owned')">
                        üëë Owned
                    </div>
                </div>

                <div class="controls">
                    <input type="text" class="search-box" placeholder="Search servers..." value="${state.searchTerm}" oninput="updateSearch(this.value)"/>
                    <select class="btn" onchange="updateSort(this.value)">
                        <option value="name" ${state.sortBy === 'name' ? 'selected' : ''}>Name (A-Z)</option>
                        <option value="members" ${state.sortBy === 'members' ? 'selected' : ''}>Member Count</option>
                        <option value="growth" ${state.sortBy === 'growth' ? 'selected' : ''}>Growth</option>
                    </select>
                    <button class="btn" onclick="selectAll()">Select All</button>
                    <button class="btn" onclick="deselectAll()">Deselect All</button>
                    <button class="btn" onclick="selectSmallServers()">Select Small</button>
                    <button class="btn" onclick="showBulkCategoryModal()" ${stats.selected === 0 ? 'disabled' : ''}>
                        üìÅ Categorize ${stats.selected}
                    </button>
                    <button class="btn btn-primary" onclick="openSelectedServers()" ${stats.selected === 0 ? 'disabled' : ''}>
                        Open ${stats.selected} Selected
                    </button>
                </div>

                <div class="item-list">
                    ${filtered.map((server, i) => {
                        const isSelected = state.selectedServers.has(server.id);
                        const categories = categorizeServer(server);
                        const growth = getServerGrowth(server.id);
                        const permissions = analyzePermissions(server);

                        return `
                            <div class="item-card ${isSelected ? 'selected' : ''}" style="animation-delay: ${i * 0.05}s">
                                <div class="item-header">
                                    <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleServer('${server.id}')"/>
                                    <div class="item-icon">
                                        ${server.icon ? `<img src="${server.icon}" alt="${server.name}">` : server.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="item-info">
                                        <div class="item-name">${server.name}</div>
                                        <div class="item-subtitle">
                                            ${server.memberCount.toLocaleString()} members
                                            ${server.owner ? ' ‚Ä¢ Owner' : ''}
                                            ${growth ? ` ‚Ä¢ ${growth.trending === 'up' ? 'üìà' : growth.trending === 'down' ? 'üìâ' : '‚û°Ô∏è'} ${growth.percentChange}%` : ''}
                                        </div>
                                        <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                            ${categories.filter(c => c !== 'owned' && c !== 'large').map(cat => {
                                                if (cat === 'uncategorized') {
                                                    return `<span class="badge badge-secondary">‚ùì Uncategorized</span>`;
                                                }
                                                const catInfo = CATEGORIES[cat];
                                                return catInfo ? `<span class="badge badge-primary">${catInfo.emoji} ${catInfo.label}</span>` : '';
                                            }).join('')}
                                            ${categories.includes('large') ? `<span class="badge badge-danger">üèÜ Large</span>` : ''}
                                            ${permissions.length > 0 ? `<span class="badge badge-${permissions[0].level === 'high' ? 'danger' : 'warning'}">‚ö†Ô∏è ${permissions[0].text}</span>` : ''}
                                            <button class="badge badge-secondary" onclick="event.stopPropagation(); showCategoryModal('${server.id}', '${server.name.replace(/'/g, "\\'")}');" style="cursor: pointer; border: 1px dashed var(--border); background: transparent;">
                                                + Category
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <a href="https://discord.com/channels/${server.id}" target="_blank" class="btn" style="flex: 1; text-decoration: none; text-align: center;">
                                        Open in Discord
                                    </a>
                                    ${!server.owner ? `
                                        <button class="btn btn-danger" onclick="openServerWithInstructions('${server.id}', '${server.name.replace(/'/g, "\\'")}')">
                                            Leave Server
                                        </button>
                                    ` : `
                                        <button class="btn" disabled title="You own this server">Owner</button>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderToolsTab() {
            const duplicates = findDuplicateServers();
            const highRiskServers = state.servers.filter(s => {
                const perms = analyzePermissions(s);
                return perms.some(p => p.level === 'high');
            });

            return `
                <div class="insight-grid">
                    <div class="insight-section">
                        <h3>üîß Bulk Actions</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            Perform actions on multiple servers at once
                        </p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="selectSmallServers()">Select Small Servers</button>
                            <button class="btn" onclick="exportToCSV()">üìä Export to CSV</button>
                            <button class="btn" onclick="exportToJSON()">üìÑ Export to JSON</button>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                üí° <strong>Tip:</strong> Select servers on the Servers tab, then use "üìÅ Categorize" to organize them in bulk!
                            </p>
                        </div>
                    </div>

                    <div class="insight-section">
                        <h3>üîç Duplicate Detector</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Find servers you might be in multiple times
                        </p>
                        ${duplicates.length > 0 ? `
                            <div class="warning-box">
                                <strong>‚ö†Ô∏è ${duplicates.length} potential duplicate${duplicates.length > 1 ? 's' : ''} found!</strong>
                                <p style="margin-top: 0.5rem;">You may be in the same community multiple times.</p>
                            </div>
                            <button class="btn btn-primary" onclick="showDuplicateModal()">View Duplicates</button>
                        ` : `
                            <div class="info-box">
                                <p><strong>‚úÖ No duplicates found!</strong></p>
                                <p>You don't appear to be in any servers multiple times.</p>
                            </div>
                        `}
                    </div>

                    <div class="insight-section">
                        <h3>üîê Permission Auditor</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Servers where you have elevated permissions
                        </p>
                        ${highRiskServers.length > 0 ? `
                            <div class="warning-box">
                                <strong>‚ö†Ô∏è ${highRiskServers.length} server${highRiskServers.length > 1 ? 's' : ''} with Admin access</strong>
                                <p style="margin-top: 0.5rem;">Review these servers to ensure you trust them.</p>
                            </div>
                            ${highRiskServers.slice(0, 5).map(s => {
                                const perms = analyzePermissions(s);
                                return `
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                                        <div style="font-weight: bold;">${s.name}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.25rem;">
                                            ${perms.map(p => `<span class="badge badge-${p.level === 'high' ? 'danger' : 'warning'}">${p.text}</span>`).join(' ')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        ` : `
                            <div class="info-box">
                                <p><strong>‚úÖ No admin permissions</strong></p>
                                <p>You don't have administrator access in any servers (except those you own).</p>
                            </div>
                        `}
                    </div>

                    <div class="insight-section">
                        <h3>üìà Server Growth Tracker</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Track member count changes over time
                        </p>
                        ${state.lastSnapshot ? `
                            <div class="info-box">
                                <p><strong>üì∏ Last snapshot:</strong> ${new Date(state.lastSnapshot).toLocaleDateString()}</p>
                                <p style="margin-top: 0.5rem;">
                                    Tracking ${Object.keys(state.growthHistory).length} servers with ${Object.values(state.growthHistory).reduce((sum, h) => sum + h.length, 0)} total data points.
                                </p>
                            </div>
                            ${state.servers.filter(s => getServerGrowth(s.id)).slice(0, 5).map(s => {
                                const growth = getServerGrowth(s.id);
                                return `
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: bold;">${s.name}</div>
                                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                                    ${s.memberCount.toLocaleString()} members
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-weight: bold; color: var(--accent-${growth.trending === 'up' ? 'primary' : growth.trending === 'down' ? 'danger' : 'secondary'});">
                                                    ${growth.trending === 'up' ? 'üìà' : growth.trending === 'down' ? 'üìâ' : '‚û°Ô∏è'} ${growth.percentChange}%
                                                </div>
                                                <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                                    ${growth.dataPoints} snapshots
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        ` : `
                            <div class="info-box">
                                <p><strong>üìä Growth tracking started!</strong></p>
                                <p style="margin-top: 0.5rem;">Come back tomorrow to see member count changes.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderInsightsTab() {
            const ownedServers = state.servers.filter(s => s.owner);
            const largeServers = state.servers.filter(s => s.memberCount > 5000).sort((a, b) => b.memberCount - a.memberCount);
            const smallServers = state.servers.filter(s => s.memberCount < 50);
            const totalMembers = state.servers.reduce((sum, s) => sum + s.memberCount, 0);
            const avgMembers = Math.round(totalMembers / state.servers.length);
            
            const categoryCounts = {};
            state.servers.forEach(s => {
                categorizeServer(s).forEach(cat => {
                    categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
                });
            });

            return `
                <div class="insight-grid">
                    ${state.connections.length > 0 ? `
                        <div class="insight-section">
                            <h3>üîó Connected Accounts</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Accounts you've linked to Discord
                            </p>
                            ${state.connections.map(conn => `
                                <div class="connection-item">
                                    <div class="connection-icon">${conn.type.charAt(0).toUpperCase()}</div>
                                    <div class="connection-details">
                                        <div class="connection-name">${conn.name}</div>
                                        <div class="connection-type">${conn.type.charAt(0).toUpperCase() + conn.type.slice(1)}${conn.verified ? ' ‚Ä¢ Verified' : ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                            <a href="https://discord.com/settings/connections" target="_blank" class="btn" style="width: 100%; text-decoration: none; text-align: center; margin-top: 1rem;">
                                Manage Connections
                            </a>
                        </div>
                    ` : `
                        <div class="insight-section">
                            <h3>üîó Connected Accounts</h3>
                            <p style="color: var(--text-secondary);">
                                No connected accounts found. Link accounts like Spotify, Xbox, or GitHub!
                            </p>
                            <a href="https://discord.com/settings/connections" target="_blank" class="btn" style="width: 100%; text-decoration: none; text-align: center; margin-top: 1rem;">
                                Connect Accounts
                            </a>
                        </div>
                    `}

                    <div class="insight-section">
                        <h3>üìä Server Distribution</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${state.servers.length}</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${categoryCounts.gaming || 0}</div>
                                <div class="stat-label">Gaming</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${categoryCounts.personal || 0}</div>
                                <div class="stat-label">Personal</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${categoryCounts.work || 0}</div>
                                <div class="stat-label">Work</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${totalMembers.toLocaleString()}</div>
                                <div class="stat-label">Total Members</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${avgMembers.toLocaleString()}</div>
                                <div class="stat-label">Avg/Server</div>
                            </div>
                        </div>
                    </div>

                    ${largeServers.length > 0 ? `
                        <div class="insight-section">
                            <h3>üèÜ Largest Communities</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Your biggest servers by member count
                            </p>
                            ${largeServers.slice(0, 5).map((s, i) => `
                                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                                    <div style="background: var(--accent-primary); color: var(--bg-primary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                        ${i + 1}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 0.25rem;">${s.name}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem;">${s.memberCount.toLocaleString()} members</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${ownedServers.length > 0 ? `
                        <div class="insight-section">
                            <h3>üëë Servers You Own</h3>
                            ${ownedServers.map(s => `
                                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: bold; margin-bottom: 0.25rem;">${s.name}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem;">${s.memberCount.toLocaleString()} members</div>
                                    </div>
                                    <a href="https://discord.com/channels/${s.id}" target="_blank" class="btn" style="text-decoration: none;">
                                        Manage
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            // Not authenticated
            if (!state.isAuthenticated && !state.loading) {
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div style="margin-bottom: 2rem;">
                                <div style="width: 120px; height: 120px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 4rem; box-shadow: 0 10px 40px var(--shadow);">
                                    üìä
                                </div>
                            </div>
                            <h1>Discord Manager</h1>
                            <p class="subtitle">Complete Discord Server Management Suite</p>
                        </div>
                        
                        ${state.error ? `<div class="error">Error: ${state.error}</div>` : ''}
                        
                        <div class="info-box">
                            <h2 style="color: var(--accent-primary); margin-bottom: 1rem; font-size: 1.5rem;">What is Discord Manager?</h2>
                            <p>Discord Manager is a free, privacy-focused web application that helps you organize and manage your Discord servers efficiently. No installation required - just login with Discord OAuth and start organizing!</p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin: 3rem 0;">
                            <div class="insight-section">
                                <h3>üöÄ Features</h3>
                                <div style="color: var(--text-secondary);">
                                    <p>‚Ä¢ <strong>Smart Organization:</strong> Categorize servers with custom tags</p>
                                    <p>‚Ä¢ <strong>Growth Tracking:</strong> Monitor member count changes over time</p>
                                    <p>‚Ä¢ <strong>Security Audit:</strong> Find servers with elevated permissions</p>
                                    <p>‚Ä¢ <strong>Bulk Actions:</strong> Manage multiple servers at once</p>
                                    <p>‚Ä¢ <strong>Export Data:</strong> Download your server list as CSV/JSON</p>
                                    <p>‚Ä¢ <strong>Duplicate Detection:</strong> Find servers you're in multiple times</p>
                                </div>
                            </div>

                            <div class="insight-section">
                                <h3>üîê Privacy & Security</h3>
                                <div style="color: var(--text-secondary);">
                                    <p>‚Ä¢ <strong>No Data Storage:</strong> We don't store your Discord data on our servers</p>
                                    <p>‚Ä¢ <strong>Local Storage Only:</strong> Your categories and preferences stay in your browser</p>
                                    <p>‚Ä¢ <strong>OAuth Authentication:</strong> Secure Discord login - we never see your password</p>
                                    <p>‚Ä¢ <strong>Open Source:</strong> Transparent code you can review</p>
                                    <p>‚Ä¢ <strong>No Tracking:</strong> We don't use analytics or tracking cookies</p>
                                    <p>‚Ä¢ <strong>Read-Only Access:</strong> We can't modify your servers or send messages</p>
                                </div>
                            </div>

                            <div class="insight-section">
                                <h3>‚ùì How It Works</h3>
                                <div style="color: var(--text-secondary);">
                                    <p><strong>1. Login:</strong> Click "Login with Discord" below</p>
                                    <p><strong>2. Authorize:</strong> Grant permission to view your servers (read-only)</p>
                                    <p><strong>3. Organize:</strong> Categorize, filter, and manage your servers</p>
                                    <p><strong>4. Export:</strong> Download your organized server list anytime</p>
                                    <p><strong>5. Track:</strong> Watch server growth over time with automatic snapshots</p>
                                </div>
                            </div>
                        </div>

                        <div class="info-box" style="margin-top: 2rem;">
                            <h3 style="color: var(--accent-primary); margin-bottom: 1rem;">‚ö†Ô∏è Important Note</h3>
                            <p><strong>This is NOT a phishing site!</strong> Discord Manager uses official Discord OAuth for authentication. We never ask for your password and cannot access your account credentials.</p>
                            <p style="margin-top: 1rem;">If your antivirus flagged this site, it's a false positive because we're a new domain. You can safely whitelist discordmanage.com or <a href="https://www.avg.com/en-us/false-positive-file-form" target="_blank" style="color: var(--accent-secondary);">report the false positive to your antivirus</a>.</p>
                        </div>

                        <div class="login-section">
                            <button class="login-btn" onclick="handleDiscordLogin()">Login with Discord</button>
                            <p style="color: var(--text-secondary); margin-top: 1rem; font-size: 0.9rem;">
                                By logging in, you agree to our <a href="#" onclick="showPrivacyPolicy(); return false;" style="color: var(--accent-primary);">Privacy Policy</a> and <a href="#" onclick="showTerms(); return false;" style="color: var(--accent-primary);">Terms of Service</a>
                            </p>
                        </div>

                        <div style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Created by <a href="https://x.com/ObiWanBENobiETH" target="_blank" style="color: var(--accent-primary);">@ObiWanBENobiETH</a></p>
                            <p style="color: var(--text-secondary); font-size: 0.85rem;">
                                Questions or issues? Contact me on <a href="https://x.com/ObiWanBENobiETH" target="_blank" style="color: var(--accent-secondary);">Twitter/X</a>
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            // Loading
            if (state.loading) {
                app.innerHTML = `
                    <div class="container">
                        <div class="header"><h1>Discord Manager</h1></div>
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading your data...</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Authenticated
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>Discord Manager</h1>
                        <p class="subtitle">Complete Server Management Suite</p>
                    </div>

                    ${state.error ? `<div class="error">${state.error}</div>` : ''}

                    ${state.user ? `
                        <div class="user-info">
                            <img class="user-avatar" src="https://cdn.discordapp.com/avatars/${state.user.id}/${state.user.avatar}.png?size=128" alt="Avatar" onerror="this.style.display='none'">
                            <div class="user-details">
                                <div class="user-name">${state.user.username}${state.user.discriminator !== '0' ? '#' + state.user.discriminator : ''}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Connected to Discord</div>
                            </div>
                            <button class="btn" onclick="handleLogout()">Logout</button>
                        </div>

                        <div class="tabs">
                            <button class="tab ${state.currentTab === 'servers' ? 'active' : ''}" onclick="switchTab('servers')">
                                üìã Servers (${state.servers.length})
                            </button>
                            <button class="tab ${state.currentTab === 'tools' ? 'active' : ''}" onclick="switchTab('tools')">
                                üîß Tools
                            </button>
                            <button class="tab ${state.currentTab === 'insights' ? 'active' : ''}" onclick="switchTab('insights')">
                                üìä Insights
                            </button>
                        </div>
                    ` : ''}

                    ${state.currentTab === 'servers' ? renderServersTab() : ''}
                    ${state.currentTab === 'tools' ? renderToolsTab() : ''}
                    ${state.currentTab === 'insights' ? renderInsightsTab() : ''}
                </div>
            `;
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
